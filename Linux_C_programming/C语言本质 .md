# Linux Cç¼–ç¨‹ä¸€ç«™å¼å­¦ä¹ 

## ç¬¬14ç« . è®¡ç®—æœºä¸­æ•°çš„è¡¨ç¤º

### 1. ä¸ºä»€ä¹ˆè®¡ç®—æœºç”¨äºŒè¿›åˆ¶è®¡æ•°

![1-bit Full Adder](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/number.digitallogic.png)





## ç¬¬15ç«  æ•°æ®ç±»å‹è¯¦è§£

### 1.æ•´å½¢

charå‹ç¬¦å·ä¾æ®å¹³å°æ¥ç¡®å®šï¼ŒCæ ‡å‡†ï¼š**ä¼˜å…ˆè€ƒè™‘æ•ˆç‡ï¼Œè€Œå¯ç§»æ¤æ€§å°šåœ¨å…¶æ¬¡**ã€‚

Cè¯­è¨€ä¸å¹³å°å’Œç¼–è¯‘å™¨æ˜¯å¯†ä¸å¯åˆ†çš„ï¼Œç¦»å¼€äº†å…·ä½“çš„å¹³å°å’Œç¼–è¯‘å™¨è®¨è®ºCè¯­è¨€ï¼Œå°±åªèƒ½è®¨è®ºåˆ°æœ¬ä¹¦ç¬¬ä¸€éƒ¨åˆ†çš„ç¨‹åº¦äº†ã€‚æ³¨æ„ï¼ŒASCIIç çš„å–å€¼èŒƒå›´æ˜¯0~127ï¼Œæ‰€ä»¥ä¸ç®¡`char`å‹æ˜¯æœ‰ç¬¦å·çš„è¿˜æ˜¯æ— ç¬¦å·çš„ï¼Œå­˜ä¸€ä¸ªASCIIç éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœç”¨`char`å‹å­˜ASCIIç å­—ç¬¦ï¼Œå°±ä¸å¿…æ˜ç¡®å†™æ˜¯`signed`è¿˜æ˜¯`unsigned`ï¼Œå¦‚æœç”¨`char`å‹è¡¨ç¤º8ä½çš„æ•´æ•°ï¼Œä¸ºäº†å¯ç§»æ¤æ€§å°±å¿…é¡»å†™æ˜æ˜¯`signed`è¿˜æ˜¯`unsigned`ã€‚

> ###  Implementation-definedã€Unspecifiedå’ŒUndefined
>
> * Implementation-defined
>
>   Cè¯­è¨€æ ‡å‡†æœªæ˜ç¡®è¯¥è§„å®šï¼Œéœ€è¦ä¾æ®ç¼–è¯‘å™¨ä½œå‡ºè§„å®šã€‚
>
> * Unspecified
>
>   å¾€å¾€æœ‰å‡ ç§å¯é€‰çš„å¤„ç†æ–¹å¼ï¼ŒCæ ‡å‡†æ²¡æœ‰æ˜ç¡®è§„å®šæŒ‰å“ªç§æ–¹å¼å¤„ç†ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªå·±å†³å®šï¼Œè¿™æ ·å³ä¾¿ç”¨åŒä¸€ä¸ªç¼–è¯‘å™¨çš„ä¸åŒç‰ˆæœ¬æ¥ç¼–è¯‘ä¹Ÿå¯èƒ½å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œå› ä¸ºç¼–è¯‘å™¨æ²¡æœ‰åœ¨æ–‡æ¡£ä¸­æ˜ç¡®å†™å®ƒä¼šæ€ä¹ˆå¤„ç†ï¼Œé‚£ä¹ˆä¸åŒç‰ˆæœ¬çš„ç¼–è¯‘å™¨å°±å¯ä»¥é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
>
> * Undefined
>
>   Cæ ‡å‡†æ²¡è§„å®šæ€ä¹ˆå¤„ç†ï¼Œç¼–è¯‘å™¨å¾ˆå¯èƒ½ä¹Ÿæ²¡è§„å®šï¼Œç”šè‡³ä¹Ÿæ²¡åšå‡ºé”™å¤„ç†ï¼Œæœ‰å¾ˆå¤šUndefinedçš„æƒ…å†µç¼–è¯‘å™¨æ˜¯æ£€æŸ¥ä¸å‡ºæ¥çš„ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œæ¯”å¦‚æ•°ç»„è®¿é—®è¶Šç•Œå°±æ˜¯Undefinedçš„ã€‚

#### æ‰“å°`int`çš„ä¸‹ç•Œ

```c
printf("%d\n",-2147483648);   
```

```bash
gcc Int.c -std=c99
Int.c: In function â€˜mainâ€™:
Int.c:5:14: warning: format â€˜%dâ€™ expects argument of type â€˜intâ€™, but argument 2 has type â€˜long intâ€™ [-Wformat=]
    5 |     printf("%d\n",-2147483648);
      |             ~^    ~~~~~~~~~~~
      |              |    |
      |              int  long int
      |             %ld
```

Cç¼–è¯‘å™¨æŠŠå®ƒå½“æˆä¸€ä¸ªæ•´æ•°å¸¸é‡`2147483648`å’Œä¸€ä¸ªè´Ÿå·è¿ç®—ç¬¦è¡¨è¾¾å¼ï¼Œè€Œæ•´æ•°å¸¸é‡2147483648 > 2147483647è¶…è¿‡äº†`int`å‹çš„å–å€¼èŒƒå›´ï¼Œ

ä½†æ˜¯æ”¹ä¸º

```c
printf("%d\n", -2147483647-1);
```

ç¼–è¯‘å™¨ä»ç„¶ä¼šè­¦å‘Šï¼Œæ­¤å¤„æœ‰BUGï¼ï¼ï¼

#### ç±»å‹è½¬æ¢

```c
long long i = 1234567890 * 1234567890;
```

```
warning: integer overflow in expression of type â€˜intâ€™ results in â€˜304084036â€™ [-Woverflow]
    6 |     long long i = 1234567890 * 1234567890;
      |                              ^
```

ä¸¤ä¸ª`int`å‹ï¼Œè€Œä¹˜ç§¯è¶…è¿‡äº†æ•´å½¢èŒƒå›´ï¼Œå› æ­¤æç¤ºç»“æœæº¢å‡ºã€‚æ”¹ä¸ºå¦‚ä¸‹å³å¯

```c
long long i = 1234567890LL * 1234567890;
```

ä¸€ä¸ªä¸ºlong long,å¦ä¸€ä¸ªä¹Ÿä¼šå…ˆè½¬æ¢ä¸ºLong longå†è¿›è¡Œè¿ç®—ã€‚



### 2. æµ®ç‚¹å‹

ä¸å¹³å°ç›¸å…³æ€§å¾ˆå¤§ï¼š

* æµ®ç‚¹è¿ç®—å•å…ƒï¼šFPU ï¼ˆFloating Point Unitï¼‰
* æ•´æ•°æ¨¡æ‹Ÿæµ®ç‚¹è¿ç®—

#### æµ®ç‚¹æ•°å†™æ³•ï¼š

* ç§‘å­¦è®¡æ•°æ³•ï¼š3.e-1ã€.987
* åç¼€ï¼šf\F(float å‹)ï¼Œl\L(Long double)ï¼Œæ²¡æœ‰åç¼€ä¸ºdouble



## ç¬¬ 16 ç«  è¿ç®—ç¬¦è¯¦è§£

### 1. ä½è¿ç®—

> æ“ä½œæ•°å¿…é¡»æ˜¯æ•´å½¢

```c
unsigned char c = 0xfc;
unsigned int i = ~c;
```

#### è¿ç®—è¿‡ç¨‹ï¼š

1. å¸¸é‡0xfcä¸ºæ•´å‹
2. è½¬æ¢ä¸º unsigned char èµ‹å€¼ç»™C
3. è®¡ç®—~C,å…ˆè½¬æ¢ä¸ºæ•´å½¢ï¼Œç„¶åå–å
4. å¾—åˆ°ffffff03ï¼Œèµ‹å€¼ç»™i

#### 1.2 ç§»ä½è¿ç®—

åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œå·¦ç§»ä¸€ä½ç›¸å½“äºä¹˜2ï¼Œç§»ä½æ“ä½œå¯¹è´Ÿæ•°è®¡ç®—æ¶ˆè€—æœ‰ç‚¹é«˜ï¼Œå› ä¸ºè¦ä¿æŒæœ€é«˜ä½1



#### 1.4 å¼‚æˆ–

1. ä¸€ä¸ªæ•°å’Œè‡ªå·±åšå¼‚æˆ–çš„ç»“æœæ˜¯0ã€‚åšå¼‚æˆ–è¿ç®—ç”Ÿæˆçš„0æ¯”è¯»å–ä¸€ä¸ª0æ›´å¿«ï¼Œå› ä¸ºæ— å¯„å­˜å™¨è¯»å–æ“ä½œ

2. ä»å¼‚æˆ–çš„çœŸå€¼è¡¨å¯ä»¥çœ‹å‡ºï¼Œä¸ç®¡æ˜¯0è¿˜æ˜¯1ï¼Œå’Œ0åšå¼‚æˆ–ä¿æŒåŸå€¼ä¸å˜ï¼Œå’Œ1åšå¼‚æˆ–å¾—åˆ°åŸå€¼çš„ç›¸åå€¼ã€‚é…åˆæ©ç å®ç°æŸäº›ä½çš„ç¿»è½¬

3. å¦‚æœa1 ^ a2 ^ a3 ^ ... ^ ançš„ç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºa1ã€a2ã€a3...anä¹‹ä¸­1çš„ä¸ªæ•°ä¸ºå¥‡æ•°ä¸ªï¼Œå¦åˆ™ä¸ºå¶æ•°ä¸ªã€‚è¿™æ¡æ€§è´¨å¯ç”¨äºå¥‡å¶æ ¡éªŒï¼ˆParity Checkï¼‰ï¼Œæ¯”å¦‚åœ¨ä¸²å£é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªå­—èŠ‚çš„æ•°æ®éƒ½è®¡ç®—ä¸€ä¸ªæ ¡éªŒä½ï¼Œæ•°æ®å’Œæ ¡éªŒä½ä¸€èµ·å‘é€å‡ºå»ï¼Œè¿™æ ·æ¥æ”¶æ–¹å¯ä»¥æ ¹æ®æ ¡éªŒä½ç²—ç•¥åœ°åˆ¤æ–­æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯å¦æœ‰è¯¯ã€‚

4. x ^ x ^ y == yï¼Œå› ä¸ºx ^ x == 0ï¼Œ0 ^ y == yã€‚è¿™ä¸ªæ€§è´¨æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šäº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼ï¼Œä¸å¾—å€ŸåŠ©é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å°±ä¸èƒ½é‡‡ç”¨`temp = a; a = b; b = temp;`çš„åŠæ³•äº†ã€‚åˆ©ç”¨ä½è¿ç®—å¯ä»¥è¿™æ ·åšäº¤æ¢ï¼š

   ```c
   a = a ^ b;
   b = b ^ a;
   a = a ^ b;
   ```

   1. a = a0 ^ b0
   2. b = b0 ^ a0 ^ b0
   3. a = a0 ^ b0 ^ a0



### 2. å…¶ä»–è¿ç®—ç¬¦

#### 2.1 å¤åˆè¿ç®—ç¬¦

> Compound Assignment Operator

a += 1 ä¸ a = a + 1

* å‰è€…æ±‚å€¼ä¸€æ¬¡(å¯„å­˜å™¨è¯»å–ä¸€æ¬¡)
* åè€…æ±‚å€¼ä¸¤æ¬¡
* åœ¨æ•ˆç‡ä¸Šå’Œå‰¯ä½œç”¨ä¸Šå‰è€…éƒ½è¾ƒå¥½



#### 2.3 é€—å·è¿ç®—ç¬¦

```c
int t = 5;
int c = (t=3, t+2);
printf("%d\n", c);
```

1. t èµ‹å€¼ä¸º3
2. c èµ‹å€¼ä¸º t+2



#### 2.4 sizeof and typedef

`sizeof`è¿”å›å€¼ç±»å‹ä¸ºsize_t

```c
int a[12];
printf("%d\n",sizeof a/sizeof a[0]);
```

```bash
size.c:6:14: warning: format â€˜%dâ€™ expects argument of type â€˜intâ€™, but argument 2 has type â€˜long unsigned intâ€™ [-Wformat=]
    6 |     printf("%d\n",sizeof a/sizeof a[0]);
      |             ~^    ~~~~~~~~~~~~~~~~~~~~
      |              |    |
      |              int  long unsigned int
      |             %ld
```

å¯å¾—å‡ºsize_t ç±»å‹ä¸º `long unsigned int`

typedef è¡¨ç¤ºä¸ºç±»å‹å–ä¸€ä¸ªæ–°åå­—

```c
typedef unsigned long int size_t;
```

* å°†`unsigned long int` å–åä¸º `size_t`
* å¦‚æœä¸åŠ ä¸Štypedefï¼Œsize_tè¡¨ç¤ºå˜é‡å



## ç¬¬ 17 ç«  è®¡ç®—æœºä½“ç³»ç»“æ„åŸºç¡€

### 2. CPU

> ä»å†…å­˜å–æŒ‡ä»¤ï¼Œç„¶åè§£é‡Šæ‰§è¡Œï¼Œç„¶ä¼šå–ä¸‹ä¸€æ¡æŒ‡ä»¤



### 3. è®¾å¤‡

#### æ¶æ„ï¼š

* å†…å­˜æ˜ å°„IOï¼šCPUç›´æ¥è¿æ¥è®¾å¤‡å¯„å­˜å™¨ç±»ä¼¼ç›´æ¥è®¿é—®å†…å­˜
* ç«¯å£IOï¼šå¼•å‡ºé¢å¤–çš„æ€»çº¿æ¥æ¥è®¾å¤‡ï¼ˆä¸“ç”¨è®¿é—®ï¼‰

#### æ‰§è¡Œè¿‡ç¨‹

åœ¨x86å¹³å°ä¸Šï¼Œç¡¬ç›˜æ˜¯æŒ‚åœ¨IDEã€SATAæˆ–SCSIæ€»çº¿ä¸Šçš„è®¾å¤‡ï¼Œä¿å­˜åœ¨ç¡¬ç›˜ä¸Šçš„ç¨‹åºæ˜¯ä¸èƒ½è¢«CPUç›´æ¥å–æŒ‡ä»¤æ‰§è¡Œçš„ï¼Œæ“ä½œç³»ç»Ÿåœ¨æ‰§è¡Œç¨‹åºæ—¶ä¼šæŠŠå®ƒä»ç¡¬ç›˜æ‹·è´åˆ°å†…å­˜ï¼Œè¿™æ ·CPUæ‰èƒ½å–æŒ‡ä»¤æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºåŠ è½½ï¼ˆLoadï¼‰ã€‚ç¨‹åºåŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œæˆä¸ºæ“ä½œç³»ç»Ÿè°ƒåº¦æ‰§è¡Œçš„ä¸€ä¸ªä»»åŠ¡ï¼Œå°±ç§°ä¸ºè¿›ç¨‹ï¼ˆProcessï¼‰ã€‚è¿›ç¨‹å’Œç¨‹åºä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä¸€ä¸ªç¨‹åºå¯ä»¥å¤šæ¬¡åŠ è½½åˆ°å†…å­˜ï¼Œæˆä¸ºåŒæ—¶è¿è¡Œçš„å¤šä¸ªè¿›ç¨‹ï¼Œä¾‹å¦‚å¯ä»¥åŒæ—¶å¼€å¤šä¸ªç»ˆç«¯çª—å£ï¼Œæ¯ä¸ªçª—å£éƒ½è¿è¡Œä¸€ä¸ªShellè¿›ç¨‹ï¼Œè€Œå®ƒä»¬å¯¹åº”çš„ç¨‹åºéƒ½æ˜¯ç£ç›˜ä¸Šçš„`/bin/bash`æ–‡ä»¶ã€‚

#### æ“ä½œç³»ç»Ÿå¯åŠ¨

æ“ä½œç³»ç»Ÿï¼ˆOperating Systemï¼‰æœ¬èº«ä¹Ÿæ˜¯ä¸€æ®µä¿å­˜åœ¨ç£ç›˜ä¸Šçš„ç¨‹åºï¼Œè®¡ç®—æœºåœ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ®µå›ºå®šçš„å¯åŠ¨ä»£ç ï¼ˆç§°ä¸ºBootloaderï¼‰é¦–å…ˆæŠŠæ“ä½œç³»ç»Ÿä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œç„¶åæ‰§è¡Œæ“ä½œç³»ç»Ÿä¸­çš„ä»£ç æŠŠç”¨æˆ·éœ€è¦çš„å…¶å®ƒç¨‹åºåŠ è½½åˆ°å†…å­˜ã€‚æ“ä½œç³»ç»Ÿå’Œå…¶å®ƒç”¨æˆ·ç¨‹åºçš„ä¸åŒä¹‹å¤„åœ¨äºï¼šæ“ä½œç³»ç»Ÿæ˜¯å¸¸é©»å†…å­˜çš„ï¼Œè€Œå…¶å®ƒç”¨æˆ·ç¨‹åºåˆ™ä¸ä¸€å®šï¼Œç”¨æˆ·éœ€è¦è¿è¡Œå“ªä¸ªç¨‹åºï¼Œæ“ä½œç³»ç»Ÿå°±æŠŠå®ƒåŠ è½½åˆ°å†…å­˜ï¼Œç”¨æˆ·ä¸éœ€è¦å“ªä¸ªç¨‹åºï¼Œæ“ä½œç³»ç»Ÿå°±æŠŠå®ƒç»ˆæ­¢æ‰ï¼Œé‡Šæ”¾å®ƒæ‰€å çš„å†…å­˜ã€‚æ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯ç®¡ç†è¿›ç¨‹è°ƒåº¦ã€ç®¡ç†å†…å­˜çš„åˆ†é…ä½¿ç”¨å’Œç®¡ç†å„ç§è®¾å¤‡ï¼Œåšè¿™äº›å·¥ä½œçš„ç¨‹åºç§°ä¸ºå†…æ ¸ï¼ˆKernelï¼‰ï¼Œåœ¨æˆ‘çš„ç³»ç»Ÿä¸Šå†…æ ¸ç¨‹åºæ˜¯`/boot/vmlinuz-2.6.28-13-generic`æ–‡ä»¶ï¼Œå®ƒåœ¨è®¡ç®—æœºå¯åŠ¨æ—¶åŠ è½½åˆ°å†…å­˜å¹¶å¸¸é©»å†…å­˜ã€‚å¹¿ä¹‰ä¸Šæ“ä½œç³»ç»Ÿçš„æ¦‚å¿µè¿˜åŒ…æ‹¬ä¸€äº›å¿…ä¸å¯å°‘çš„ç”¨æˆ·ç¨‹åºï¼Œæ¯”å¦‚Shellæ˜¯æ¯ä¸ªLinuxç³»ç»Ÿå¿…ä¸å¯å°‘çš„ï¼Œè€ŒOfficeåŠå…¬å¥—ä»¶åˆ™æ˜¯å¯æœ‰å¯æ— çš„ï¼Œæ‰€ä»¥å‰è€…ä¹Ÿå±äºå¹¿ä¹‰ä¸Šæ“ä½œç³»ç»Ÿçš„èŒƒç•´ï¼Œè€Œåè€…å±äºåº”ç”¨è½¯ä»¶ã€‚

#### ä¸­æ–­

è®¿é—®è®¾å¤‡è¿˜æœ‰ä¸€ç‚¹å’Œè®¿é—®å†…å­˜ä¸åŒã€‚å†…å­˜åªæ˜¯ä¿å­˜æ•°æ®è€Œä¸ä¼šäº§ç”Ÿæ–°çš„æ•°æ®ï¼Œå¦‚æœCPUä¸å»è¯»å®ƒï¼Œå®ƒä¹Ÿä¸éœ€è¦ä¸»åŠ¨æä¾›æ•°æ®ç»™CPUï¼Œæ‰€ä»¥å†…å­˜æ€»æ˜¯è¢«åŠ¨åœ°ç­‰å¾…è¢«è¯»æˆ–è€…è¢«å†™ã€‚è€Œè®¾å¤‡å¾€å¾€ä¼šè‡ªå·±äº§ç”Ÿæ•°æ®ï¼Œå¹¶ä¸”éœ€è¦ä¸»åŠ¨é€šçŸ¥CPUæ¥è¯»è¿™äº›æ•°æ®ï¼Œä¾‹å¦‚æ•²é”®ç›˜äº§ç”Ÿä¸€ä¸ªè¾“å…¥å­—ç¬¦ï¼Œç”¨æˆ·å¸Œæœ›è®¡ç®—æœºé©¬ä¸Šå“åº”è‡ªå·±çš„è¾“å…¥ï¼Œè¿™å°±è¦æ±‚é”®ç›˜è®¾å¤‡ä¸»åŠ¨é€šçŸ¥CPUæ¥è¯»è¿™ä¸ªå­—ç¬¦å¹¶åšç›¸åº”å¤„ç†ï¼Œç»™ç”¨æˆ·å“åº”ã€‚è¿™æ˜¯ç”±ä¸­æ–­ï¼ˆInterruptï¼‰æœºåˆ¶å®ç°çš„ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€æ¡ä¸­æ–­çº¿ï¼Œé€šè¿‡ä¸­æ–­æ§åˆ¶å™¨è¿æ¥åˆ°CPUï¼Œå½“è®¾å¤‡éœ€è¦ä¸»åŠ¨é€šçŸ¥CPUæ—¶å°±å¼•å‘ä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼ŒCPUæ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤å°†è¢«æ‰“æ–­ï¼Œç¨‹åºè®¡æ•°å™¨ä¼šæŒ‡å‘æŸä¸ªå›ºå®šçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€ç”±ä½“ç³»ç»“æ„å®šä¹‰ï¼‰ï¼Œäºæ˜¯CPUä»è¿™ä¸ªåœ°å€å¼€å§‹å–æŒ‡ä»¤ï¼ˆæˆ–è€…è¯´è·³è½¬åˆ°è¿™ä¸ªåœ°å€ï¼‰ï¼Œæ‰§è¡Œä¸­æ–­æœåŠ¡ç¨‹åºï¼ˆISRï¼ŒInterrupt Service Routineï¼‰ï¼Œå®Œæˆä¸­æ–­å¤„ç†ä¹‹åå†è¿”å›å…ˆå‰è¢«æ‰“æ–­çš„åœ°æ–¹æ‰§è¡Œåç»­æŒ‡ä»¤ã€‚æ¯”å¦‚æŸç§ä½“ç³»ç»“æ„è§„å®šå‘ç”Ÿä¸­æ–­æ—¶è·³è½¬åˆ°åœ°å€0x00000010æ‰§è¡Œï¼Œé‚£ä¹ˆå°±è¦äº‹å…ˆæŠŠä¸€æ®µISRç¨‹åºåŠ è½½åˆ°è¿™ä¸ªåœ°å€ï¼ŒISRç¨‹åºæ˜¯å†…æ ¸ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨è¿™æ®µä»£ç ä¸­é¦–å…ˆåˆ¤æ–­æ˜¯å“ªä¸ªè®¾å¤‡å¼•å‘äº†ä¸­æ–­ï¼Œç„¶åè°ƒç”¨è¯¥è®¾å¤‡çš„ä¸­æ–­å¤„ç†å‡½æ•°åšè¿›ä¸€æ­¥å¤„ç†ã€‚

ç”±äºå„ç§è®¾å¤‡çš„æ“ä½œæ–¹æ³•å„ä¸ç›¸åŒï¼Œæ¯ç§è®¾å¤‡éƒ½éœ€è¦ä¸“é—¨çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆDevice Driverï¼‰ï¼Œä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸ºäº†æ”¯æŒå¹¿æ³›çš„è®¾å¤‡å°±éœ€è¦æœ‰å¤§é‡çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œäº‹å®ä¸ŠLinuxå†…æ ¸æºä»£ç ä¸­ç»å¤§éƒ¨åˆ†æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚è®¾å¤‡é©±åŠ¨ç¨‹åºé€šå¸¸æ˜¯å†…æ ¸é‡Œçš„ä¸€ç»„å‡½æ•°ï¼Œé€šè¿‡è¯»å†™è®¾å¤‡å¯„å­˜å™¨å®ç°å¯¹è®¾å¤‡çš„åˆå§‹åŒ–ã€è¯»ã€å†™ç­‰æ“ä½œï¼Œæœ‰äº›è®¾å¤‡è¿˜è¦æä¾›ä¸€ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ä¾›ISRè°ƒç”¨ã€‚



### 3. MMU

æ“ä½œç³»ç»Ÿé‡‡ç”¨ è™šæ‹Ÿå†…å­˜ç®¡ç†ï¼ˆVirtual Memory Managementï¼‰æœºåˆ¶ï¼Œéœ€è¦

> MMUï¼ˆMemory Management Unitï¼Œå†…å­˜ç®¡ç†å•å…ƒï¼‰

#### ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜

ç‰©ç†å†…å­˜ï¼šCPUæ‰§è¡Œå•å…ƒå°†å†…å­˜åœ°å€ç›´æ¥ä¼ è¾“åˆ°å†…å­˜èŠ¯ç‰‡å¼•è„šä¸Šæ¥å—

![ç‰©ç†åœ°å€](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/arch.pabox.png)

CPUæ‰§è¡Œå•å…ƒå‘å‡ºçš„å†…å­˜åœ°å€å°†è¢«MMUæˆªè·ï¼Œä»CPUåˆ°MMUçš„åœ°å€ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼ˆVirtual Addressï¼Œä»¥ä¸‹ç®€ç§°VAï¼‰ï¼Œè€ŒMMUå°†è¿™ä¸ªåœ°å€ç¿»è¯‘æˆå¦ä¸€ä¸ªåœ°å€å‘åˆ°CPUèŠ¯ç‰‡çš„å¤–éƒ¨åœ°å€å¼•è„šä¸Š

![è™šæ‹Ÿåœ°å€](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/arch.vabox.png)

è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´æ˜¯ç‹¬ç«‹çš„ï¼Œ32ä½å¤„ç†å™¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯4GBï¼Œè€Œç‰©ç†åœ°å€ç©ºé—´æ—¢å¯ä»¥å¤§äºä¹Ÿå¯ä»¥å°äº4GBã€‚

MMUå°†VAæ˜ å°„åˆ°PAæ˜¯ä»¥é¡µï¼ˆPageï¼‰ä¸ºå•ä½çš„ï¼Œ32ä½å¤„ç†å™¨çš„é¡µå°ºå¯¸é€šå¸¸æ˜¯4KBã€‚ä¾‹å¦‚ï¼ŒMMUå¯ä»¥é€šè¿‡ä¸€ä¸ªæ˜ å°„é¡¹å°†VAçš„ä¸€é¡µ0xb7001000~0xb7001fffæ˜ å°„åˆ°PAçš„ä¸€é¡µ0x2000~0x2fffï¼Œå¦‚æœCPUæ‰§è¡Œå•å…ƒè¦è®¿é—®è™šæ‹Ÿåœ°å€0xb7001008ï¼Œåˆ™å®é™…è®¿é—®åˆ°çš„ç‰©ç†åœ°å€æ˜¯0x2008ã€‚ç‰©ç†å†…å­˜ä¸­çš„é¡µç§°ä¸ºç‰©ç†é¡µé¢æˆ–è€…é¡µå¸§ï¼ˆPage Frameï¼‰ã€‚è™šæ‹Ÿå†…å­˜çš„å“ªä¸ªé¡µé¢æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„å“ªä¸ªé¡µå¸§æ˜¯é€šè¿‡é¡µè¡¨ï¼ˆPage Tableï¼‰æ¥æè¿°çš„ï¼Œé¡µè¡¨ä¿å­˜åœ¨ç‰©ç†å†…å­˜ä¸­ï¼ŒMMUä¼šæŸ¥æ‰¾é¡µè¡¨æ¥ç¡®å®šä¸€ä¸ªVAåº”è¯¥æ˜ å°„åˆ°ä»€ä¹ˆPAã€‚ï¼ˆå­—å…¸ä¸ç´¢å¼•ï¼‰



#### æ“ä½œç³»ç»Ÿä¸MMU

1. å¯åŠ¨æ—¶ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸­å¡«è¡¨
2. ç”¨æŒ‡ä»¤è®©MMUçŸ¥é“é¡µè¡¨åœ¨ç‰©ç†å†…å­˜çš„å“ªä¸ªåœ°æ–¹
3. CPUè®¿é—®å†…å­˜éƒ½ä¼šå…ˆè®©MMUæŸ¥è¡¨å’Œåœ°å€è½¬æ¢
4. åœ°å€è½¬æ¢å¯ä»¥æœ‰ç¡¬ä»¶è‡ªåŠ¨å®Œæˆ



#### ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸€å±‚

> All problems in computer science can be solved by another level of indirection.



#### MMUåŠŸèƒ½

* ä¿æŠ¤å†…å­˜ï¼šè®¾ç½®é¡µé¢è®¿é—®æƒé™

![å¤„ç†å™¨æ¨¡å¼](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/arch.cpumode.png)

#### è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†

* å†…æ ¸ç©ºé—´
* ç”¨æˆ·ç©ºé—´

ä¾‹å¦‚x86å¹³å°çš„Linuxç³»ç»Ÿè™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯0x00000000~0xffffffffï¼Œå‰3GBï¼ˆ0x00000000~0xbfffffffï¼‰æ˜¯ç”¨æˆ·ç©ºé—´ï¼Œå1GBï¼ˆ0xc0000000~0xffffffffï¼‰æ˜¯å†…æ ¸ç©ºé—´ã€‚

##### ç©ºé—´åˆ‡æ¢

ç”¨æˆ·ç¨‹åºåŠ è½½åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œï¼Œä¸èƒ½è®¿é—®å†…æ ¸ä¸­çš„æ•°æ®ï¼Œä¹Ÿä¸èƒ½è·³è½¬åˆ°å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿æŠ¤å†…æ ¸ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹è®¿é—®äº†éæ³•åœ°å€ï¼Œé¡¶å¤šè¿™ä¸€ä¸ªè¿›ç¨‹å´©æºƒï¼Œè€Œä¸ä¼šå½±å“åˆ°å†…æ ¸å’Œæ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚CPUåœ¨äº§ç”Ÿä¸­æ–­æˆ–å¼‚å¸¸æ—¶ä¸ä»…ä¼šè·³è½¬åˆ°ä¸­æ–­æˆ–å¼‚å¸¸æœåŠ¡ç¨‹åºï¼Œè¿˜ä¼šè‡ªåŠ¨åˆ‡æ¢æ¨¡å¼ï¼Œä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°ç‰¹æƒæ¨¡å¼ï¼Œå› æ­¤ä»ä¸­æ–­æˆ–å¼‚å¸¸æœåŠ¡ç¨‹åºå¯ä»¥è·³è½¬åˆ°å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚äº‹å®ä¸Šï¼Œæ•´ä¸ªå†…æ ¸å°±æ˜¯ç”±å„ç§ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†ç¨‹åºç»„æˆçš„ã€‚æ€»ç»“ä¸€ä¸‹ï¼šåœ¨æ­£å¸¸æƒ…å†µä¸‹å¤„ç†å™¨åœ¨ç”¨æˆ·æ¨¡å¼æ‰§è¡Œç”¨æˆ·ç¨‹åºï¼Œåœ¨ä¸­æ–­æˆ–å¼‚å¸¸æƒ…å†µä¸‹å¤„ç†å™¨åˆ‡æ¢åˆ°ç‰¹æƒæ¨¡å¼æ‰§è¡Œå†…æ ¸ç¨‹åºï¼Œå¤„ç†å®Œä¸­æ–­æˆ–å¼‚å¸¸ä¹‹åå†è¿”å›ç”¨æˆ·æ¨¡å¼ç»§ç»­æ‰§è¡Œç”¨æˆ·ç¨‹åºã€‚



#### æ®µé”™è¯¯çš„äº§ç”Ÿ

1. ç”¨æˆ·ç¨‹åºè®¿é—®è™šæ‹Ÿå†…å­˜ï¼Œæ— æƒæŸ¥çœ‹
2. MMUäº§ç”Ÿå¼‚å¸¸ï¼ŒCPUä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°ç‰¹æƒæ¨¡å¼ï¼Œè·³è½¬åˆ°å†…æ ¸ä»£ç æ‰§è¡Œå¼‚å¸¸æœåŠ¡ç¨‹åº
3. å†…æ ¸æŠŠè¿™ä¸ªå¼‚å¸¸è§£é‡Šä¸ºæ®µé”™è¯¯ï¼ŒæŠŠå¼•å‘å¼‚å¸¸çš„è¿›ç¨‹ä¸­æ­¢ã€‚



### 5. Memory Hierarchy

#### Cache:

å’ŒMMUä¸€æ ·ä½äºCPUæ ¸ä¸­ã€‚

Cacheç¼“å­˜æœ€è¿‘è®¿é—®è¿‡çš„å†…å­˜æ•°æ®ï¼Œç”±äºCacheçš„è®¿é—®é€Ÿåº¦æ˜¯å†…å­˜çš„å‡ åå€ï¼Œæ‰€ä»¥æœ‰æ•ˆåˆ©ç”¨Cacheå¯ä»¥å¤§å¤§æé«˜è®¡ç®—æœºçš„æ•´ä½“æ€§èƒ½ã€‚ä¸€çº§Cacheæ˜¯è¿™æ ·å·¥ä½œçš„ï¼šCPUæ‰§è¡Œå•å…ƒè¦è®¿é—®å†…å­˜æ—¶é¦–å…ˆå‘å‡ºVAï¼ŒCacheåˆ©ç”¨VAæŸ¥æ‰¾ç›¸åº”çš„æ•°æ®æœ‰æ²¡æœ‰è¢«ç¼“å­˜ï¼Œå¦‚æœCacheä¸­æœ‰å°±ä¸éœ€è¦è®¿é—®ç‰©ç†å†…å­˜äº†ï¼Œå¦‚æœæ˜¯è¯»æ“ä½œå°±ç›´æ¥å°†Cacheä¸­çš„æ•°æ®ä¼ ç»™CPUå¯„å­˜å™¨ï¼Œå¦‚æœæ˜¯å†™æ“ä½œå°±ç›´æ¥æ”¹å†™åˆ°Cacheä¸­ï¼›å¦‚æœCacheæ²¡æœ‰ç¼“å­˜è¯¥æ•°æ®ï¼Œ**å°±å»ç‰©ç†å†…å­˜ä¸­å–æ•°æ®ï¼Œä½†å¹¶ä¸æ˜¯è¦å“ªä¸ªå­—èŠ‚å°±å–å“ªä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯æŠŠç›¸é‚»çš„å‡ åä¸ªå­—èŠ‚éƒ½å–ä¸Šæ¥ç¼“å­˜ç€ï¼Œä»¥å¤‡ä¸‹æ¬¡ç”¨åˆ°ï¼Œè¿™ç§°ä¸ºä¸€ä¸ªCache Lineï¼Œå…¸å‹çš„Cache Lineå¤§å°æ˜¯32~256å­—èŠ‚ã€‚**

å¦‚æœè®¡ç®—æœºè¿˜é…ç½®äº†äºŒçº§ç¼“å­˜ï¼Œåˆ™åœ¨è®¿é—®ç‰©ç†å†…å­˜ä¹‹å‰å…ˆç”¨PAå»äºŒçº§ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚ä¸€çº§ç¼“å­˜æ˜¯ç”¨VAå¯»å€çš„ï¼ŒäºŒçº§ç¼“å­˜æ˜¯ç”¨PAå¯»å€çš„ï¼Œè¿™æ˜¯å®ƒä»¬çš„åŒºåˆ«ã€‚Cacheæ‰€åšçš„å·¥ä½œæ˜¯ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆçš„ï¼Œè€Œä¸æ˜¯åƒå¯„å­˜å™¨ä¸€æ ·ç”±æŒ‡ä»¤å†³å®šå…ˆåšä»€ä¹ˆååšä»€ä¹ˆã€‚

Cacheä»å†…å­˜å–æ•°æ®æ—¶ä¼šé¢„å–ä¸€ä¸ªCache Lineç¼“å­˜èµ·æ¥ï¼Œæ“ä½œç³»ç»Ÿä»ç¡¬ç›˜è¯»æ•°æ®æ—¶ä¼šé¢„è¯»å‡ ä¸ªé¡µé¢ç¼“å­˜èµ·æ¥ï¼Œéƒ½æ˜¯å¸Œæœ›è¿™äº›æ•°æ®ä»¥åä¼šè¢«ç¨‹åºè®¿é—®åˆ°ã€‚

å¤§å¤šæ•°ç¨‹åºçš„è¡Œä¸ºéƒ½å…·æœ‰å±€éƒ¨æ€§ï¼ˆLocalityï¼‰çš„ç‰¹ç‚¹ï¼šå®ƒä»¬ä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´åå¤æ‰§è¡Œä¸€å°æ®µä»£ç ï¼ˆä¾‹å¦‚å¾ªç¯ï¼‰ï¼Œæˆ–è€…åå¤è®¿é—®ä¸€ä¸ªå¾ˆå°çš„åœ°å€èŒƒå›´ä¸­çš„æ•°æ®ï¼ˆä¾‹å¦‚è®¿é—®ä¸€ä¸ªæ•°ç»„ï¼‰ã€‚æ‰€ä»¥é¢„è¯»ç¼“å­˜çš„åŠæ³•æ˜¯å¾ˆæœ‰æ•ˆçš„ï¼šCPUå–ä¸€æ¡æŒ‡ä»¤ï¼Œæˆ‘æŠŠå’Œå®ƒç›¸é‚»çš„æŒ‡ä»¤ä¹Ÿéƒ½ç¼“å­˜èµ·æ¥ï¼ŒCPUå¾ˆå¯èƒ½é©¬ä¸Šå°±ä¼šå–åˆ°ï¼›CPUè®¿é—®ä¸€ä¸ªæ•°æ®ï¼Œæˆ‘æŠŠå’Œå®ƒç›¸é‚»çš„æ•°æ®ä¹Ÿéƒ½ç¼“å­˜èµ·æ¥ï¼ŒCPUå¾ˆå¯èƒ½é©¬ä¸Šå°±ä¼šè®¿é—®åˆ°ã€‚

è®¾æƒ³æœ‰ä¸¤å°è®¡ç®—æœºï¼Œä¸€å°æœ‰256KBçš„Cacheï¼Œå¦ä¸€å°æ²¡æœ‰Cacheï¼Œä¸¤å°è®¡ç®—æœºçš„å†…å­˜éƒ½æ˜¯512MBçš„ï¼Œç¡¬ç›˜éƒ½æ˜¯100GBçš„ï¼Œè™½ç„¶å¤šå‡ºæ¥256KBçš„Cacheä¸å†…å­˜ã€ç¡¬ç›˜çš„å®¹é‡ç›¸æ¯”å¾®ä¸è¶³é“ï¼Œä½†è®¿é—®Cacheæ¯”è®¿é—®å†…å­˜ã€ç¡¬ç›˜å¿«å‡ ä¸ªæ•°é‡çº§ï¼Œç”±äºå±€éƒ¨æ€§åŸç†ï¼ŒCPUå¤§éƒ¨åˆ†æ—¶é—´æ˜¯åœ¨å’ŒCacheæ‰“äº¤é“ï¼Œæœ‰Cacheçš„è®¡ç®—æœºæ˜æ˜¾ä¼šå¿«å¾ˆå¤šã€‚é«˜é€Ÿå­˜å‚¨å™¨çš„å®¹é‡åªèƒ½åšå¾—å¾ˆå°ï¼Œå´èƒ½æ˜¾è‘—æå‡è®¡ç®—æœºçš„æ€§èƒ½ï¼Œè¿™å°±æ˜¯Memory Hierarchyçš„æ„ä¹‰æ‰€åœ¨ã€‚



## ç¬¬ 18 ç«  x86æ±‡ç¼–ç¨‹åºåŸºç¡€

### 1.æœ€ç®€å•çš„æ±‡ç¼–ç¨‹åº

```assembly
#PURPOSE: Simple program that exits and returns a  #ä»£è¡¨å•è¡Œæ³¨é‡Š
#	  status code back to the Linux kernel
#
#INPUT:   none
#
#OUTPUT:  returns a status code. This can be viewed
#	  by typing
#
#	  echo $?
#
#	  after running the program
#
#VARIABLES:
#	  %eax holds the system call number
#	  %ebx holds the return status
#

# ä»¥.å¼€å¤´  è¡¨ç¤ºç‰¹æ®ŠæŒ‡ä»¤
# .sectioè¡¨ç¤ºæŠŠä»£ç åˆ†æˆè‹¥å¹²æ®µ ä¸åŒæ®µæœ‰ä¸åŒç¨‹åºå’Œä¸åŒæƒé™
# .dataæ®µä¿å­˜ç¨‹åºçš„æ•°æ® ç±»ä¼¼Cè¯­è¨€å…¨å±€å˜é‡
 .section .data

# .textä¿å­˜ä»£ç  åªè¯»å¯æ‰§è¡Œ åç»­æŒ‡ä»¤éƒ½å±äº.textæ®µ
 .section .text
 
 # _startè¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œç¬¦å·åœ¨æ±‡ç¼–ç¨‹åºä¸­ä»£è¡¨ä¸€ä¸ªåœ°å€
 .globl _start
_start:
 movl $1, %eax	# this is the linux kernel command
		# number (system call) for exiting
		# a program

 movl $4, %ebx	# this is the status number we will
		# return to the operating system.
		# Change this around and it will
		# return different things to
		# echo $?

 int $0x80	# this wakes up the kernel to run
		# the exit command
```



#### æ±‡ç¼–ç¨‹åºè¿è¡Œæµç¨‹

1. æ±‡ç¼–å™¨asæŠŠæ±‡ç¼–ç¨‹åºçš„ä¸»ç»™ä»˜ç¿»è¯‘æˆæœºå™¨ï¼Œç”Ÿæˆç›®æ ‡æ–‡ä»¶

   ```bash
   $ as hello.s -o hello.o
   ```

2. é“¾æ¥å™¨ï¼ˆLinker, æˆ–Link Editorï¼‰`ld` æŠŠç›®æ ‡æ–‡ä»¶`hello.o`é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶`hello`ï¼š

   ```bash
   $ ld hello.o -o hello
   ```

   è¿æ¥çš„ä½œç”¨ï¼š

   * ä¿®æ”¹ç›®æ ‡æ–‡ä»¶ä¿¡æ¯ï¼Œå¯¹åœ°å€åšé‡å®šå‘
   * å¤šä¸ªç›®æ ‡æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

3. å¾—åˆ°ä¸Šä¸€æ¡å‘½ä»¤çš„é€€å‡ºçŠ¶æ€

   ```bash
   echo $?
   0
   ```



#### å˜é‡å’Œå‡½æ•°æœ¬è´¨

åœ¨Cè¯­è¨€ä¸­æˆ‘ä»¬é€šè¿‡å˜é‡åè®¿é—®ä¸€ä¸ªå˜é‡ï¼Œå…¶å®å°±æ˜¯è¯»å†™æŸä¸ªåœ°å€çš„å†…å­˜å•å…ƒï¼Œæˆ‘ä»¬é€šè¿‡å‡½æ•°åè°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å®å°±æ˜¯è·³è½¬åˆ°è¯¥å‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰€åœ¨çš„åœ°å€ï¼Œæ‰€ä»¥å˜é‡åå’Œå‡½æ•°åéƒ½æ˜¯ç¬¦å·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä»£è¡¨å†…å­˜åœ°å€çš„ã€‚



```assembly
.gloabl _start
```

`globl`æŒ‡ç¤ºå‘Šè¯‰æ±‡ç¼–å™¨ï¼Œ`_start`è¿™ä¸ªç¬¦å·è¦è¢«é“¾æ¥å™¨ç”¨åˆ°ï¼Œæ‰€ä»¥è¦åœ¨ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­æ ‡è®°å®ƒæ˜¯ä¸€ä¸ªå…¨å±€ç¬¦å·ï¼ˆåœ¨[ç¬¬ 5.1 èŠ‚ â€œç›®æ ‡æ–‡ä»¶â€](https://docs.huihoo.com/c/linux-c-programming/ch18s05.html#asm.relocatable)è¯¦ç»†è§£é‡Šï¼‰ã€‚`_start`å°±åƒCç¨‹åºçš„`main`å‡½æ•°ä¸€æ ·ç‰¹æ®Šï¼Œæ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£ï¼Œé“¾æ¥å™¨åœ¨é“¾æ¥æ—¶ä¼šæŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶ä¸­çš„`_start`ç¬¦å·ä»£è¡¨çš„åœ°å€ï¼ŒæŠŠå®ƒè®¾ç½®ä¸ºæ•´ä¸ªç¨‹åºçš„å…¥å£åœ°å€ï¼Œæ‰€ä»¥æ¯ä¸ªæ±‡ç¼–ç¨‹åºéƒ½è¦æä¾›ä¸€ä¸ª`_start`ç¬¦å·å¹¶ä¸”ç”¨`.globl`å£°æ˜ã€‚å¦‚æœä¸€ä¸ªç¬¦å·æ²¡æœ‰ç”¨`.globl`å£°æ˜ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªç¬¦å·ä¸ä¼šè¢«é“¾æ¥å™¨ç”¨åˆ°ã€‚

```assembly
_start:
```

ä¸¤ä¸ª_start: 

* ä¸€ä¸ªä»£è¡¨å®é™…åœ°å€  ğŸ 
* ä¸€ä¸ªä»£è¡¨å¼€é—¨çš„é’¥åŒ™ ğŸ”‘_

è€Œ`_start`è¿™ä¸ªç¬¦å·åˆæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ‰€ä»£è¡¨çš„åœ°å€æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£åœ°å€ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¡æŒ‡ä»¤`movl $1, %eax`å°±æˆäº†ç¨‹åºä¸­ç¬¬ä¸€æ¡è¢«æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

```assembly
movl $1, %eax
```

`mov`çš„åç¼€lè¡¨ç¤ºlongï¼Œè¯´æ˜æ˜¯32ä½çš„ä¼ é€æŒ‡ä»¤ã€‚è¿™æ¡æŒ‡ä»¤ä¸è¦æ±‚CPUè¯»å†…å­˜ï¼Œ1è¿™ä¸ªæ•°æ˜¯åœ¨CPUå†…éƒ¨äº§ç”Ÿçš„ï¼Œç§°ä¸ºç«‹å³æ•°ï¼ˆImmediateï¼‰ã€‚åœ¨æ±‡ç¼–ç¨‹åºä¸­ï¼Œç«‹å³æ•°å‰é¢è¦åŠ $ï¼Œå¯„å­˜å™¨åå‰é¢è¦åŠ %ï¼Œä»¥ä¾¿è·Ÿç¬¦å·ååŒºåˆ†å¼€ã€‚ä»¥åæˆ‘ä»¬ä¼šçœ‹åˆ°`mov`æŒ‡ä»¤è¿˜æœ‰å¦å¤–å‡ ç§å½¢å¼ï¼Œä½†æ•°æ®ä¼ é€æ–¹å‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ªæ“ä½œæ•°æ€»æ˜¯æºæ“ä½œæ•°ï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°æ€»æ˜¯ç›®æ ‡æ“ä½œæ•°ã€‚

```assembly
int $0x80
```

ç³»ç»Ÿè°ƒç”¨ï¼Œè½¯ä¸­æ–­å¤„ç†ï¼Œäº§ç”Ÿå¼‚å¸¸ï¼Œåˆ‡æ¢ç”¨æˆ·çŠ¶æ€ï¼Œç±»ä¼¼äº§ç”Ÿä¸€ä¸ªå‡½æ•°

ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼Œä¸€ä¸ªå‚æ•°ï¼Œç±»ä¼¼å‡½æ•°çš„å‡½æ•°åå’Œå‡½æ•°å‚æ•°ã€‚



```assembly
_exit
```

* ç›´æ¥ç»ˆæ­¢å½“å‰è¿›ç¨‹



### 4.å¯»å€æ–¹å¼

* ç›´æ¥å¯»å€

  ```assembly
  movl ADDRESS, %eax
  ```

* å˜å€å¯»å€

  ```assembly
  movl data_items(,%edi,4), %eax
  ```

  ç”¨äºè®¿é—®æ•°ç»„

* é—´æ¥å¯»å€ï¼ŒæŠŠæŸä¸ªåœ°å€å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­

  ```assembly
  movl (%eax), %ebx
  ```

* åŸºå€å¯»å€

  ```assembly
  movl 4(%eax), %ebx
  ```

  4ä¸ºåç§»é‡

* ç«‹å³å¯»å€

  ```assembly
  movl $12, %eax $12
  ```

  åœ¨CPUå†…äº§ç”Ÿæ•°å­—

* å¯„å­˜å™¨å¯»å€

  ```assembly
  movl $12, %eax
  ```

â€‹		æŒ‡ä»¤ä¸­æœ‰ä¸ªæ“ä½œæ•°æ˜¯å¯„å­˜å™¨



### 5.FLE æ–‡ä»¶æ ¼å¼

* å¯é‡å®šä½çš„æ–‡ä»¶
* å¯æ‰§è¡Œçš„æ–‡ä»¶
* å…±äº«æ–‡ä»¶

ç°åœ¨è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªç¨‹åºçš„æ±‡ç¼–ã€é“¾æ¥ã€è¿è¡Œè¿‡ç¨‹ï¼š

1. å†™ä¸€ä¸ªæ±‡ç¼–ç¨‹åºä¿å­˜æˆæ–‡æœ¬æ–‡ä»¶`max.s`ã€‚
2. æ±‡ç¼–å™¨è¯»å–è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶è½¬æ¢æˆç›®æ ‡æ–‡ä»¶`max.o`ï¼Œç›®æ ‡æ–‡ä»¶ç”±è‹¥å¹²ä¸ªSectionç»„æˆï¼Œæˆ‘ä»¬åœ¨æ±‡ç¼–ç¨‹åºä¸­å£°æ˜çš„`.section`ä¼šæˆä¸ºç›®æ ‡æ–‡ä»¶ä¸­çš„Sectionï¼Œæ­¤å¤–æ±‡ç¼–å™¨è¿˜ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›Sectionï¼ˆæ¯”å¦‚ç¬¦å·è¡¨ï¼‰ã€‚
3. ç„¶åé“¾æ¥å™¨æŠŠç›®æ ‡æ–‡ä»¶ä¸­çš„Sectionåˆå¹¶æˆå‡ ä¸ªSegment[[28](https://docs.huihoo.com/c/linux-c-programming/ch18s05.html#ftn.id2770769)]ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶`max`ã€‚
4. æœ€ååŠ è½½å™¨ï¼ˆLoaderï¼‰æ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„Segmentä¿¡æ¯åŠ è½½è¿è¡Œè¿™ä¸ªç¨‹åºã€‚



#### ELFæ–‡ä»¶

![ELFæ–‡ä»¶](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/asm.elfoverview.png)



* ELF Headerï¼šä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿçš„ä¿¡æ¯ï¼Œå¹¶æŒ‡å‡ºæ–‡ä»¶å¼€å§‹å’Œç»“æŸçš„ä½ç½®ï¼ˆprogram\section header tableï¼‰
* section header table ä¿å­˜æ‰€æœ‰ sectionçš„æè¿°ä¿¡æ¯



#### ç›®æ ‡æ–‡ä»¶

`readelf` è¯»å‡ºELF Headerå’ŒSection Header Table

```bash
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V # ç³»ç»Ÿ
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           Advanced Micro Devices X86-64 #ä½“ç³»ç»“æ„
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          504 (bytes into file) #ä»è¿™ä¸ªåœ°å€å¼€å§‹
  Flags:                             0x0
  Size of this header:               64 (bytes) 
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes) # æ¯ä¸ªsection header å 40è‡ªå·±å­—èŠ‚
  Number of section headers:         8 
  Section header string table index: 7
```



##### Section Headerä¿¡æ¯

```bash
Section Headers:
  [Nr] Name              Type             Address(è™šæ‹Ÿåœ°å€ï¼Œç”¨äºé“¾æ¥)   Offset(ä¹‹å¤„sectionæ–‡ä»¶åœ°å€)
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       000000000000002d  0000000000000000  AX       0     0     1
  [ 2] .rela.text        RELA             0000000000000000  00000190
       0000000000000030  0000000000000018   I       5     1     8
  [ 3] .data             PROGBITS         0000000000000000  0000006d
       0000000000000038  0000000000000000  WA       0     0     1
  [ 4] .bss              NOBITS           0000000000000000  000000a5
       0000000000000000  0000000000000000  WA       0     0     1
  [ 5] .symtab           SYMTAB           0000000000000000  000000a8
       00000000000000c0  0000000000000018           6     7     8
  [ 6] .strtab           STRTAB           0000000000000000  00000168
       0000000000000028  0000000000000000           0     0     1
  [ 7] .shstrtab         STRTAB           0000000000000000  000001c0
       0000000000000031  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)

There are no section groups in this file.

There are no program headers in this file.

There is no dynamic section in this file.
```

å·¦è¾¹ä¸€åˆ—æ˜¯æ–‡ä»¶åœ°å€ï¼Œä¸­é—´æ˜¯æ¯ä¸ªå­—èŠ‚çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œå³è¾¹æ˜¯æŠŠè¿™äº›å­—èŠ‚è§£é‡ŠæˆASCIIç æ‰€å¯¹åº”çš„å­—ç¬¦ã€‚ä¸­é—´æœ‰ä¸€ä¸ª*å·è¡¨ç¤ºçœç•¥çš„éƒ¨åˆ†å…¨æ˜¯0ã€‚`.data`æ®µå¯¹åº”çš„æ˜¯è¿™ä¸€å—ï¼š

```bash
00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..>.............|
00000020  00 00 00 00 00 00 00 00  f8 01 00 00 00 00 00 00  |................|
00000030  00 00 00 00 40 00 00 00  00 00 40 00 08 00 07 00  |....@.....@.....|
```



```bash
Relocation section '.rela.text' at offset 0x190 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000009  00020000000a R_X86_64_32       0000000000000000 .data + 0
00000000001a  00020000000a R_X86_64_32       0000000000000000 .data + 0
# åœ¨å“ªäº›åœ°æ–¹åšé‡å®šå‘

The decoding of unwind sections for machine type Advanced Micro Devices X86-64 is not currently supported.

# ç¬¦å·è¡¨
Symbol table '.symtab' contains 8 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name #æ‰€åœ¨sectionç¼–å·
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 
     4: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    3 data_items
     5: 000000000000000f     0 NOTYPE  LOCAL  DEFAULT    1 start_loop
     6: 0000000000000026     0 NOTYPE  LOCAL  DEFAULT    1 loop_exit
     7: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    1 _start

No version information found in this file.
```





## ç¬¬ 19 ç«  æ±‡ç¼–ä¸Cçš„å…³ç³»

### 2.mainå‡½æ•°ä¸å¯åŠ¨ä¾‹ç¨‹

1. `ctrl.o`ä¸­çš„_startåˆå§‹åŒ–ï¼ˆStartup Routineï¼‰
2. è°ƒç”¨Cä»£ç ä¸­çš„mainå‡½æ•°



#### åˆ†å¸ƒç¼–è¯‘

1. å°†Cè¯­è¨€ç¼–è¯‘ä¸º.oæ–‡ä»¶

   ```bash
   gcc -o mian.o main.c
   ```

2. å°†.oæ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶

   ```bash
   gcc -o main main.o
   ```

   è¿™æ¡å‘½ä»¤æœ¬è´¨æ˜¯è°ƒç”¨`ld`å‘½ä»¤å»é“¾æ¥

   ```bash
   ld /usr/lib/crt1.o /usr/lib/crti.o main.o -o main -lc -dynamic-linker /lib/ld-linux.so.2
   ```

   -lcï¼šè°ƒç”¨åŠ¨æ€é“¾æ¥åº“

#### 

#### `ctrl.o` å¦‚ä½•è°ƒç”¨ main

```bash
$ nm /usr/lib/crt1.o 
00000000 R _IO_stdin_used
00000000 D __data_start
         U __libc_csu_fini
         U __libc_csu_init
         U __libc_start_main
00000000 R _fp_hw
00000000 T _start
00000000 W data_start
         U main
$ nm /usr/lib/crti.o
         U _GLOBAL_OFFSET_TABLE_
         w __gmon_start__
00000000 T _fini
00000000 T _init
```

**U main**ï¼Œè¡¨ç¤ºå°šæœªå®šä¹‰ï¼Œéœ€è¦æŒ‡å®šæ–‡ä»¶å°†å…¶ä¸`crtl.o`è¿æ¥æ¥æä¾›è¿™ä¸ªåœ°å€ï¼Œåœ¨æ­¤æ—¶`ld`ç±»ä¼¼ä¸€ä¸ªæŒ‡é’ˆæˆ–è€…å˜åŸº

è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹

```bash
gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/9/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none:hsa
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 9.4.0-1ubuntu1~20.04.1' --with-bugurl=file:///usr/share/doc/gcc-9/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++,gm2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-9 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-9-Av3uEd/gcc-9-9.4.0/debian/tmp-nvptx/usr,hsa --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.1) 
```

è§‚å¯Ÿ`main`æ–‡ä»¶çš„æ±‡ç¼–ä»£ç 

```
0000000000001190 <__libc_csu_init>:
0000000000001200 <__libc_csu_fini>:
```

åœ¨`crtl.o`æ–‡ä»¶ä¸­æœªå®šä¹‰çš„æ–‡ä»¶ï¼Œéƒ½é“¾æ¥äº†ç›¸å…³åœ°å€ï¼Œè€Œ`__libc_start_main`æœªå®šä¹‰ï¼Œæ­¤åº“åšè¿è¡Œæ—¶çš„åŠ¨æ€é“¾æ¥ã€‚ï¼ˆç”¨æˆ·æ‰©å±•é“¾æ¥ï¼‰

```bash
 1061:       48 8d 3d 02 01 00 00    lea    0x102(%rip),%rdi        # 116a <main>
    1068:       ff 15 72 2f 00 00       callq  *0x2f72(%rip)        # 3fe0 <__libc_start_main@GLIBC_2.2.5>
```

å–å‡ºmainå‡½æ•°çš„åœ°å€ä¼ ç»™å¯„å­˜å™¨ï¼Œç„¶åæ‰§è¡Œè¯¥åœ°å€ä¸‹çš„mainå‡½æ•°

å®é™…ä¸Šï¼ŒStartup Routineè°ƒç”¨mainå‡½æ•°çš„å½¢å¼ä¸º

```bash
exit(main(argc, argv));
```

`ctrl.o`è°ƒç”¨mainå‡½æ•°è·å–mainå‡½æ•°çš„è¿”å›å€¼ï¼Œä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨_exitï¼Œæˆä¸ºé€€å‡ºçš„è¿›ç¨‹ã€‚

æœ‰æ„æ€çš„Cè¯­è¨€ç¨‹åº

```c
#include <stdlib.h>

int main(void){
    exit(-1);
}
```

```bash
gcc test01.c ;./a.out; echo $?
255
```

å¯çœ‹åˆ°å¼‚å¸¸é€€å‡ºä¸º-1ï¼Œä¸”ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ä¸º255



### 3. å˜é‡çš„å­˜å‚¨å¸ƒå±€

#### ä¾‹å­1

```c
#include <stdio.h>

const int A = 10;
int a = 20;
static int b = 30;
int c;

int main(void){
    static int a = 40;
    char b[] = "Hello world";
    register int c = 50;

    printf("Heloo World %d\n", c);

    return 0;
}
```

* `const`
* static
* register

```bash
$ readelf -a a.out
```

æŸ¥çœ‹ç¬¦å·è¡¨

```bash
66: 0000000000002004     4 OBJECT  GLOBAL DEFAULT   18 A
69: 0000000000004020     4 OBJECT  GLOBAL DEFAULT   26 c
70: 0000000000004010     4 OBJECT  GLOBAL DEFAULT   25 a
42: 0000000000004014     4 OBJECT  LOCAL  DEFAULT   25 b 
# ç”±äº b è¢«staticä¿®é¥°è¿™ä¸ªç¬¦å·ä¸ºlocal
# localè¡¨ç¤ºè¿™ä¸ªç¬¦å·åªèƒ½åœ¨æŸä¸€ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œè€Œä¸èƒ½è¢«å…¨å±€é“¾æ¥
```

##### å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡çš„åŒºåˆ†

> ç¬¦å·è¡¨

* globalï¼šå…¨å±€å˜é‡
* localï¼š

å…·ä½“è§‚å¯Ÿå˜é‡

```bash
 43: 0000000000004018     4 OBJECT  LOCAL  DEFAULT   25 a.2320
 70: 0000000000004010     4 OBJECT  GLOBAL DEFAULT   25 a
```

å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•°ä¸­çš„staticå˜é‡ä¸åŒäºå±€éƒ¨å˜é‡ï¼š**å‡½æ•°è°ƒç”¨æ—¶åˆ†é…ï¼Œè¿”å›æ—¶é‡Šæ”¾**ï¼Œè€Œæ˜¯åƒå…¨å±€å˜é‡ä¸€æ ·é™æ€åˆ†é…ï¼Œç”±äºaå˜é‡è¿˜æ˜¯åªåœ¨å±€éƒ¨å˜é‡èµ·ä½œç”¨ï¼Œåœ¨å…¶ä»–å‡½æ•°ä¸­å°±ä¸æ˜¯æŒ‡ä»–ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªåç¼€ä¸å…¨å±€å˜é‡åŒºåˆ†



##### å‡½æ•°ä¸­çš„æ•°ç»„

```bash
char b[] = "Hello world";
1185:       48 b8 48 65 6c 6c 6f    movabs $0x6f77206f6c6c6548,%rax
118c:       20 77 6f 
118f:       48 89 45 dc             mov    %rax,-0x24(%rbp)
1193:       c7 45 e4 72 6c 64 00    movl   $0x646c72,-0x1c(%rbp)
register int c = 50;
119a:       bb 32 00 00 00          mov    $0x32,%ebx
```

å¯çŸ¥è¿™ä¸ªæ•°ç»„ç›´æ¥ç”±æŒ‡ä»¤å†™è¿›å¯„å­˜å™¨

![æ•°ç»„çš„å­˜å‚¨å¸ƒå±€2](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/asmc.array.png)

æ•°ç»„çš„åœ°å€ç”±ç¬¬ä¸€ä¸ªåŸºåœ°å€å†³å®šã€‚



registerä¿®é¥°çš„å…³é”®å­—ï¼Œç›´æ¥ç”±å¯„å­˜å™¨å­˜å‚¨ï¼Œä¸”å‡½æ•°ä½¿ç”¨è¯¥å˜é‡æ—¶ï¼Œåªå°†é¦–åœ°å€å‹å…¥å‡½æ•°æ ˆå¸§ä¸­ã€‚



#### å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡

> Scope

* å‡½æ•°ä½œç”¨åŸŸ

* æ–‡ä»¶ä½œç”¨åŸŸ

  * main
  * å…¨å±€å˜é‡
  * åº“æ–‡ä»¶å‡½æ•°(printf)

* å—ä½œç”¨åŸŸ

  * {}ä¸­ï¼Œç±»ä¼¼Javaä¸­çš„ä»£ç å—

* å‡½æ•°åŸå‹ä½œç”¨åŸŸ

  * å‡½æ•°å£°æ˜è€Œéå®šä¹‰

    ```c
    int foo(int a, int b);
    ```

    æ­¤ä¸­çš„aå’Œb



#### åŒä¸€`namespace`çš„é‡åæ ‡è¯†ç¬¦

> å†…å±‚è¦†ç›–å¤–å±‚



#### å¯ä¿®é¥°æ ‡è¯†ç¬¦çš„ä¿®é¥°ç¬¦

é“¾æ¥ç±»ï¼š

* externalï¼šç±»ä¼¼æ–‡ä»¶ä¸­çš„å…¨å±€å˜é‡
* internal
* no link

å­˜å‚¨ç±»ä¿®é¥°ç¬¦

* staticï¼šå­˜å‚¨ç©ºé—´é™æ€åˆ†é…ï¼Œinternal linkå±æ€§
* autoï¼šè‡ªåŠ¨åˆ†é…å­˜å‚¨ç©ºé—´
* registerï¼šåˆ†é…ä¸€ä¸ªä¸“é—¨çš„å¯„å­˜å™¨å‚¨å­˜ï¼Œåˆ†é…ä¸å¼€å¯„å­˜å™¨å½“ä½œauto
* externï¼šå¤šæ¬¡å£°æ˜åŒä¸€ä¸ªå˜é‡



#### å˜é‡çš„ç”Ÿå­˜æœŸ

* é™æ€ç”Ÿå­˜æœŸï¼šstaticä¿®é¥°çš„å˜é‡
* è‡ªåŠ¨ç”Ÿå­˜æœŸï¼šè¢«ä¿®é¥°çš„å˜é‡
* åŠ¨æ€ç”Ÿå­˜æœŸï¼šmalloc\free



### 4.ç»“æ„ä½“ä¸è”åˆä½“

```c
#include <stdio.h>

int main(int argc, char const *argv[])
{
    struct {
        char a;
        short b;
        int c;
        char d;
    } s;

    s.a = 1;
    s.b = 2;
    s.c = 3;
    s.d = 4;

    printf("%u\n", sizeof(s));
    
    return 0;
}

```

ç»“æ„ä½“æ±‡ç¼–ä»£ç 

```assembly
 s.a = 1;
 115c:       c6 45 f4 01             movb   $0x1,-0xc(%rbp)
 s.b = 2;
 1160:       66 c7 45 f6 02 00       movw   $0x2,-0xa(%rbp)
 s.c = 3;
 1166:       c7 45 f8 03 00 00 00    movl   $0x3,-0x8(%rbp)
 s.d = 4;
 116d:       c6 45 fc 04             movb   $0x4,-0x4(%rbp)
```

ä»ä½å‘é«˜æ’åˆ—ï¼Œç±»ä¼¼æ•°ç»„ï¼Œä½†ä¼šæœ‰ç©ºéš™ã€‚

![image-20220825085153131](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/image-20220825085153131.png)



#### å¯¹é½

> å¯¹é½çš„æŒ‡ä»¤æ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜

* `movl`ï¼šè®¿é—®4å­—èŠ‚ï¼Œæ‰€è®¿é—®å†…å­˜åœ°å€æ˜¯4çš„æ•´æ•°å€

* `movw`ï¼šè®¿é—®ä¸¤å­—èŠ‚æŒ‡ä»¤

* `movb`ï¼šè®¿é—®ä¸¤å­—èŠ‚

aå ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œbå ä¸¤ä¸ªå­—èŠ‚ï¼Œä¸ºäº†å¯¹é½ï¼Œaè¿›è¡Œå¡«å……å ä¸¤ä¸ªå­—èŠ‚ï¼ŒåŒæ ·då› ä¸ºcä¹Ÿåšäº†å­—èŠ‚å¡«å……ã€‚

gcc æ‰©å±•è¯­æ³•é¿å…å¡«å……

```c
struct {
        char a;
        short b;
        int c;
        char d;
    } __attribute__((packed)) s;
```

  

### 5.Cå†…è”æ±‡ç¼–

åŸºæœ¬æ ¼å¼`__asm__("asm code\n\t")`





### 2.mainå‡½æ•°ä¸å¯åŠ¨ä¾‹ç¨‹

> _start ä¸ mainå‡½æ•°çš„åŒºåˆ«å’Œè”ç³»



### 6.Volatitle é™å®šç¬¦

```bash
buf[0] = recv;
1131:       0f b6 05 d9 2e 00 00    movzbl 0x2ed9(%rip),%eax #4011<recv>
1138:       88 05 d4 2e 00 00       mov    %al,0x2ed4(%rip)  #4012 <buf>
buf[1] = recv;
113e:       0f b6 05 cc 2e 00 00    movzbl 0x2ecc(%rip),%eax #4011<recv>
1145:       88 05 c8 2e 00 00       mov    %al,0x2ec8(%rip)  
#4013 <buf+0x1>
buf[2] = recv;
114b:       0f b6 05 bf 2e 00 00    movzbl 0x2ebf(%rip),%eax #4011<recv>
1152:       88 05 bc 2e 00 00       mov    %al,0x2ebc(%rip)  
# 4014 <buf+0x2>
send = ~buf[0];
1158:       0f b6 05 b3 2e 00 00    movzbl 0x2eb3(%rip),%eax # 4012<buf>
115f:       f7 d0                   not    %eax
1161:       88 05 ae 2e 00 00       mov    %al,0x2eae(%rip) # 4015<send>
send = ~buf[1];
1167:       0f b6 05 a5 2e 00 00    movzbl 0x2ea5(%rip),%eax        
# 4013 <buf+0x1>
116e:       f7 d0                   not    %eax
1170:       88 05 9f 2e 00 00       mov    %al,0x2e9f(%rip) #4015 <send>
send = ~buf[2];
1176:       0f b6 05 97 2e 00 00    movzbl 0x2e97(%rip),%eax        
# 4014 <buf+0x2>
117d:       f7 d0                   not    %eax
117f:       88 05 90 2e 00 00       mov    %al,0x2e90(%rip) #4015 <send>
```

#### æ±‡ç¼–è§£è¯»

```assembly
movzbl 0x2ed9, %eax
```

movzï¼šå°†å­—é•¿çŸ­ç§»åŠ¨åˆ°å­—é•¿é•¿çš„å¯„å­˜å™¨ä¸­ï¼Œé«˜ä½ç”¨0å¡«å……

* b(byte)ï¼šå•å­èŠ‚
* w(word)ï¼šä¸¤å­—èŠ‚
* l(long)ï¼šå››å­—èŠ‚

åœ¨è¯¥æ±‡ç¼–ä»£ç ä¸­ï¼Œæ„æ€ä¸ºå°†åœ°å€0x2ed9å‡ºçš„ä¸€ä¸ªå­—èŠ‚ç§»åŠ¨åˆ°å››ä½å­—èŠ‚eaxå¯„å­˜å™¨ä¸­ã€‚

```assembly
mov	%al, 0x804a01a
```

`al`å¯„å­˜å™¨æ˜¯`eax`å¯„å­˜å™¨çš„ä½å­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå­—èŠ‚ç§»åŠ¨åˆ°`0x804a01a`çš„ä¸€ä¸ªå­—èŠ‚ä¸­ã€‚è¯¥æ“ä½œåæ˜ äº†å¯ä»¥ç”¨ä¸åŒåç§°æ¥è®¿é—®å¯„å­˜å™¨çš„ä½8ä½æˆ–è€…16ä½å­—èŠ‚ã€‚

![eaxå¯„å­˜å™¨](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/asmc.eax.png)

åœ¨`eax`å¯„å­˜å™¨ä¸­ï¼Œ`al`è¡¨ç¤ºä½8ä½ï¼Œ`ax`è¡¨ç¤ºä½16ä½ã€‚



#### å°è¯•ç¼–è¯‘ä¼˜åŒ–

æ·»åŠ `-o`ç¼–è¯‘ä¼˜åŒ–é¡¹

```bash
buf[0] = recv;
112d:       0f b6 05 dd 2e 00 00    movzbl 0x2edd(%rip),%eax#4011 <recv>
1134:       88 05 d8 2e 00 00       mov    %al,0x2ed8(%rip) #4012 <buf>
buf[1] = recv;
113a:       88 05 d3 2e 00 00       mov    %al,0x2ed3(%rip)        
# 4013 <buf+0x1>
buf[2] = recv;
1140:       88 05 ce 2e 00 00       mov    %al,0x2ece(%rip)        
# 4014 <buf+0x2>
send = ~buf[0];
1146:       f7 d0                   not    %eax
1148:       88 05 c7 2e 00 00       mov    %al,0x2ec7(%rip) #4015 <send>
send = ~buf[1];
send = ~buf[2];
```

å¯çœ‹åˆ°ï¼Œåªæœ‰ç¬¬ä¸€æ¡æŒ‡ä»¤ä»å†…å­˜ä¸­è¯»å–åˆ°äº†è¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°å¯„å­˜å™¨`eax`ä¸­ï¼Œç„¶åå°†å¯„å­˜å™¨çš„å€¼`al`ä¿å­˜åˆ°`buf[0]`ä¸­ï¼Œåç»­æŒ‡ä»¤ç›´æ¥æŠŠ`al`åˆ°å€¼ç›´æ¥ä¿å­˜åˆ°`buf[1]\buf[2]`ä¸­ã€‚

åä¸‰æ¡æŒ‡ä»¤ä¹Ÿåªæœ‰æŠŠç¬¬ä¸€æ¬¡çš„å€¼å–åï¼Œç„¶åä¿å­˜åˆ°å†…å­˜åœ°å€ä¸­ã€‚



#### volatileçš„ä½¿ç”¨

> é˜²æ­¢ç¼–è¯‘å™¨è‡ªä½œèªæ˜ï¼ŒæŠŠä¸è¯¥ä¼˜åŒ–çš„ä¼˜åŒ–äº†

```c
//artificial device registers
volatile unsigned char recv;
volatile unsigned char send;
```

åç¼–è¯‘çš„ç»“æœ

```bash
buf[0] = recv;
    112d:       0f b6 0d dd 2e 00 00    movzbl 0x2edd(%rip),%ecx        # 4011 <recv>
    1134:       88 0d d8 2e 00 00       mov    %cl,0x2ed8(%rip)        # 4012 <buf>
    buf[1] = recv;
    113a:       0f b6 15 d0 2e 00 00    movzbl 0x2ed0(%rip),%edx        # 4011 <recv>
    1141:       88 15 cc 2e 00 00       mov    %dl,0x2ecc(%rip)        # 4013 <buf+0x1>
    buf[2] = recv;
    1147:       0f b6 05 c3 2e 00 00    movzbl 0x2ec3(%rip),%eax        # 4011 <recv>
    114e:       88 05 c0 2e 00 00       mov    %al,0x2ec0(%rip)        # 4014 <buf+0x2>
    send = ~buf[0];
    1154:       f7 d1                   not    %ecx
    1156:       88 0d b9 2e 00 00       mov    %cl,0x2eb9(%rip)        # 4015 <send>
    send = ~buf[1];
    115c:       f7 d2                   not    %edx
    115e:       88 15 b1 2e 00 00       mov    %dl,0x2eb1(%rip)        # 4015 <send>
    send = ~buf[2];
    1164:       f7 d0                   not    %eax
    1166:       88 05 a9 2e 00 00       mov    %al,0x2ea9(%rip)        # 4015 <send>
```

å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰è¢«ç¼–è¯‘ä¼˜åŒ–ï¼Œä¼˜åŒ–é€‰é¡¹`01\02\03\0s`ç¼–è¯‘é€‰é¡¹é€æ¸å¢å¤šã€‚



#### Cacheçš„é€æ˜é—®é¢˜

> è¯»å†™å†…å­˜æ—¶å¯èƒ½ä»Cacheä¸­ç›´æ¥è¯»å†™ï¼Œè€Œä¸ä»å†…å­˜ä¸­è¯»å†™ã€‚

![ä¸²å£å‘é€å’Œæ¥æ”¶å¯„å­˜å™¨è¢«Cacheç¼“å­˜ä¼šæœ‰ä»€ä¹ˆé—®é¢˜](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/asmc.nocache.png)

* å¦‚æœCPUåŒæ—¶å†™å…¥ä¸‰ä¸ªå­—èŠ‚ï¼Œå¦‚æœè¢«ä¼˜åŒ–ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªå­—èŠ‚è¢«å†™å…¥Cacheä¸­
* é‚£ä¹ˆå‰ä¸¤ä¸ªå­—èŠ‚å°±è¢«ä¸¢å¤±

##### è§£å†³åŠæ³•

* åœ¨æŸä¸€æ®µèŒƒå›´ç¦ç”¨Cacheï¼Œåœ¨é¡µè¡¨ä¸­è®¾ç½®å“ªäº›Cacheé¡µé¢å¯ä»¥ç¼“å­˜
* ä¿¡å·å¤„ç†å’Œå¤šçº¿ç¨‹æƒ…å†µä¸‹ä¹Ÿéœ€è¦ä½¿ç”¨`volatile`



## ç¬¬20ç«  é“¾æ¥è¯¦è§£

### 1.å¤šç›®æ ‡æ–‡ä»¶çš„é“¾æ¥

```bash
warning: implicit declaration of function â€˜pushâ€™ [-Wimplicit-function-declaration]
```

-éšå¼å‡½æ•°å£°æ˜ è­¦å‘Š

```c
/* main.c */
#include <stdio.h>

int a, b = 1;

int main(void)
{
	push('a');
	push('b');
	push('c');
	
	while(!is_empty())
		putchar(pop());
	putchar('\n');

	return 0;
}
```

nmæŸ¥çœ‹ç¬¦å·è¡¨

```bash
# nm main.o
0000000000000004 C a
0000000000000000 D b
                 U _GLOBAL_OFFSET_TABLE_
                 U is_empty
0000000000000000 T main
                 U pop
                 U push
                 U putchar
```

å¯ä»¥çœ‹åˆ°`stack.c`ä¸`putchar`ä¸­çš„å‡½æ•°å‡ä¸ºå®šä¹‰ï¼Œ`putchar`ä¸º`libc`çš„åº“å‡½æ•°ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶`main`ä¸­æœªå®šä¹‰ã€‚

#### å…·ä½“é“¾æ¥æ–‡ä»¶

![å¤šç›®æ ‡æ–‡ä»¶çš„é“¾æ¥](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/link.multiobj.png)

ç¼–è¯‘ç¨‹åºå°†å„ä¸ªæ®µæš´åŠ›åˆå¹¶ï¼Œæ–¹ä¾¿è°ƒç”¨ã€‚

``` bash
gcc stack.o main.o -o main
```

æ ¹æ®é“¾æ¥ç¨‹åºçš„å…ˆåæ¥ç¡®å®šæœ€åå„ä¸ªæ®µä¸­ç¬¦å·çš„é¡ºåºã€‚



#### é“¾æ¥è„šæœ¬

```bash
$ ld --verbose
```

`ENTRY(_start)`è¯´æ˜`_start`æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£ç‚¹ï¼Œå› æ­¤`_start`æ˜¯å…¥å£ç‚¹å¹¶ä¸æ˜¯è§„å®šæ­»çš„ï¼Œæ˜¯å¯ä»¥æ”¹ç”¨å…¶å®ƒå‡½æ•°åšå…¥å£ç‚¹çš„ã€‚

```bash
PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x400000)); . = SEGMENT_START("text-segment", 0x400000) + SIZEOF_HEADERS;
```

è¿™æ˜¯Text Segmentçš„èµ·å§‹åœ°å€

```bash
 .interp         : { *(.interp) }
```

å·¦è¾¹è¡¨ç¤º`.interp`æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶ï¼Œè¡¨ç¤ºç”±å„ä¸ªè¢«é“¾æ¥æ–‡ä»¶çš„`.interp`æ®µç»„æˆã€‚

### 2.å®šä¹‰ä¸å£°æ˜

éšå¼å‡½æ•°å£°æ˜ï¼š

* è¿”å›å€¼ä¸ºï¼šint
* å£°æ˜æ—¶å¸¦æœ‰`extern`å°±ä¸ä¼šå¸¦æœ‰è­¦å‘Š

> ä½¿ç”¨`static`åˆ™è¡¨ç¤ºè¯¥æ ‡è¯†ç¬¦`Internal Linkage`

**æ³¨æ„å˜é‡å£°æ˜ä¸å‡½æ•°å£°æ˜`extern`åŒºåˆ«å¾ˆå¤§**



#### 2.1 Cè¯­è¨€å°è£… externå’Œstaticå…³é”®å­—

> Encapsulation

æ³¨æ„æŸäº›å˜é‡åªèƒ½ç”±å†…éƒ¨è¿›è¡Œè®¿é—®ï¼Œåº”è¯¥éœ€è¦é˜»æ­¢å¤–éƒ¨çš„è®¿é—®ï¼Œéœ€è¦å£°æ˜ä¸º`Internal Linkage`ï¼š

```c
/* stack.c */
static char stack[512];
static int top = -1;
```

è¿™æ ·åœ¨`main.c`ä¸­å£°æ˜äº†`extern`å˜é‡ä¹Ÿè®¿é—®ä¸åˆ°`top` å’Œ`stack`ï¼Œç±»ä¼¼ä¸€ç§å°è£…çš„æ€æƒ³ã€‚



#### 2.2 å¤´æ–‡ä»¶

> é˜²æ­¢é‡å¤çš„å£°æ˜ï¼Œå¼•å…¥äº†å¤´æ–‡ä»¶

```c
/*stack.h*/
#ifndef STACK_H
#define STACK_H
extern void push(char);
extern char pop(void);
extern int  is_empty(void);
#endif
```

æ­¤æ—¶ä½¿ç”¨`gcc -c main.c`ç¼–è¯‘ï¼Œä¼šç›´æ¥æ‰¾åˆ°ç›®å½•ä¸­çš„`stack.h`ã€‚

```bash
$ tree
.
|-- main.c
|-- stack.c
`-- stack.h

0 directories, 3 files
```

å¦‚æœå°†`stack.c`ä¸`stack.h`ç§»åŠ¨åˆ°åŒä¸€ä¸ªå­—ç›®å½•ä¸‹ï¼Œåˆ™éœ€è¦ä½¿ç”¨`gcc -c main.c -Istack`ç¼–è¯‘ã€‚

```bash
$ tree
.
|-- main.c
`-- stack
    |-- stack.c
    `-- stack.h

1 directory, 3 files
```



##### é¢„å®šä¹‰å®

```c
#ifndef STACK_H
#define STACK_H
```

å¦‚æœè¿™ä¸ªå®å®šä¹‰è¿‡ï¼Œé‚£ä¹ˆ`ifndef`ä¸`endif`ä¹‹é—´çš„ä»£ç å°±åŒ…å«åœ¨é¢„å¤„ç†çš„è¾“å‡ºç»“æœä¸­ï¼Œå¦åˆ™å°±ä¸åŒ…å«åœ¨é¢„å¤„ç†çš„ç»“æœä¸­ã€‚è¿™æ ·å°±é¿å…äº†åŒ…å«äº†é‡å¤çš„å†…å®¹ã€‚



##### åŒ…å«é‡å¤çš„å¤´æ–‡ä»¶

1. é¢„å¤„ç†é€Ÿåº¦å˜æ…¢
2. äº’ç›¸åŒ…å«å¤´æ–‡ä»¶ï¼Œé™·å…¥æ­»å¾ªç¯
3. æœ‰äº›å¤´æ–‡ä»¶çš„å®šä¹‰ä¸å…è®¸é‡å¤å‡ºç°



##### åŒ…å«`.h`è€Œä¸æ˜¯`.c`

æ–‡ä»¶é¡¹ç›®è¿‡å¤§ï¼Œåœ¨æ–‡ä»¶å†…éƒ¨æœ‰é‡å¤å®šä¹‰

![ä¸ºä»€ä¹ˆè¦åŒ…å«å¤´æ–‡ä»¶è€Œä¸æ˜¯.cæ–‡ä»¶](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/link.includeh.png)

æ­¤æ—¶é“¾æ¥è„šæœ¬å°±ä¸çŸ¥é“è¯¥å¦‚ä½•ç»„è£…äº†ã€‚

> æ™ºèƒ½ç»„è£…ç¨‹åºï¼Ÿï¼Ÿï¼Ÿ



#### 2.3 å®šä¹‰å’Œå£°æ˜çš„è¯¦ç»†è§„åˆ™

* extern : previous linkage
* Static : internal linkage



### 3.é™æ€åº“

> åœ¨å¤šä¸ªé¡¹ç›®ä¸­éƒ½éœ€è¦ç”¨åˆ°

é™æ€åº“æ‰“åŒ…

```bash
$ ar rs libstack.a stack.o push.o pop.o is_empty.o
ar: creating libstack.a
```

æ³¨æ„åº“åä»¥`lib`å¼€å¤´ï¼Œä»¥`.a`ä¸ºåç¼€ï¼Œè¡¨ç¤º`Archive`ï¼Œ`ar`ç±»ä¼¼`tar`å‘½ä»¤ï¼Œæ‰“åŒ…ï¼Œsç”¨äºç”Ÿæˆé™æ€åº“ï¼Œè¡¨ç¤ºå»ºç«‹ç´¢å¼•ã€‚

`ranlib`å‘½ä»¤å¯ä»¥ä¸ºé™æ€åº“åˆ›å»ºç´¢å¼•

ç„¶åå°†`libstack.a`å’Œ`main.c`ç¼–è¯‘é“¾æ¥åœ¨ä¸€èµ·ï¼š

```bash
$ gcc main.c -L. -lstack -Istack -o main
```

-Lï¼šè¡¨ç¤ºç¼–è¯‘å»å“ªé‡Œæ‰¾åº“æ–‡ä»¶

ç¼–è¯‘å™¨ä¼šé¦–å…ˆå»å¯»æ‰¾å…±äº«åº“`libstack.so`ï¼Œæ²¡æœ‰ç»§ç»­å¯»æ‰¾`libstack.a`



### 4.å…±äº«åº“

#### 4.1 ç¼–è¯‘è¿è¡Œ

```bash
$ gcc -c -fPIC stack/stack.c stack/push.c stack/pop.c stack/is_empty.c
```

ç”¨åˆ°å¤–éƒ¨çš„å‡½æ•°å’Œå˜é‡æ—¶ï¼Œä¼šåœ¨é“¾æ¥è¿‡ç¨‹è¿›è¡Œåœ°å€çš„é‡å®šå‘



### 5.è™šæ‹Ÿå†…å­˜ç®¡ç†

`/proc`ç›®å½•ä¸­çš„æ–‡ä»¶å¹¶ä¸æ˜¯çœŸæ­£çš„ç£ç›˜æ–‡ä»¶ï¼Œè€Œæ˜¯ç”±å†…æ ¸è™šæ‹Ÿå‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå½“å‰ç³»ç»Ÿä¸­è¿è¡Œçš„æ¯ä¸ªè¿›ç¨‹åœ¨`/proc`ä¸‹éƒ½æœ‰ä¸€ä¸ªå­ç›®å½•ï¼Œç›®å½•åå°±æ˜¯è¿›ç¨‹çš„idï¼ŒæŸ¥çœ‹ç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥å¾—åˆ°è¯¥è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ã€‚



#### ä½œç”¨

1. ä¿æŠ¤ç‰©ç†å†…å­˜
2. è®©æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´

![è¿›ç¨‹åœ°å€ç©ºé—´æ˜¯ç‹¬ç«‹çš„](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/link.sepva-20220902115318718.png)

* å¯è¯»éƒ¨åˆ†å…±äº«ï¼ˆå…±äº«åº“çš„æ¥æºï¼‰

3. è™šæ‹Ÿå†…å­˜çš„è¿ç»­æ˜ å°„ä¸è¿ç»­çš„ç‰©ç†å†…å­˜ï¼ˆé˜²æ­¢éœ€è¦ä¸€å¤§å—è¿ç»­å†…å­˜çš„æƒ…å†µï¼‰

![ä¸è¿ç»­çš„PAå¯ä»¥æ˜ å°„ä¸ºè¿ç»­çš„VA](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/link.discontpa-20220902115318805.png)

4. åˆ†é…æ›´å¤§çš„å†…å­˜ï¼ˆéƒ¨åˆ†å†…å®¹å¯ä¸´æ—¶ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼šäº¤æ¢è®¾å¤‡ï¼‰



## ç¬¬21ç«  é¢„å¤„ç†çš„æ­¥éª¤

* Icloudä¸¢å¼ƒæ²¡å¿…è¦çš„ç©ºç™½å’Œæ¢è¡Œç¬¦



### 2.å®å®šä¹‰

#### 2.1å‡½æ•°å¼å®

> Function-like Macro

```c
#define MAX(a, b) ((a)>(b)?(a):(b))
k = MAX(i&0x0f, j&0x0f)
```

```bash
gcc -E 
```

æŸ¥çœ‹é¢„å¤„ç†ç»“æœ

```bash
# 1 "test01.c"
# 1 "<built-in>"
# 1 "<command-line>"
# 31 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 32 "<command-line>" 2
# 1 "test01.c"


int main(int argc, char const *argv[])
{
    int k;
    k = ((i&0x0f) > (j&0x0f)?(i&0x0f):(j&0x0f));
    return 0;
}
```

ä¸å‡½æ•°è°ƒç”¨ç±»ä¼¼ï¼Œæ›¿æ¢äº†å®çš„å‚æ•°

##### å®å‡½æ•°å’Œå‡½æ•°åŒºåˆ«

* å‚æ•°æ²¡æœ‰ç±»å‹ï¼Œåªè´Ÿè´£åšå½¢å¼ä¸Šçš„æ›¿æ¢ï¼Œä¸åšå‚æ•°ç±»å‹æ£€æŸ¥
* å®ç¼–è¯‘ç”Ÿæˆçš„æŒ‡ä»¤éƒ½ç±»ä¼¼ä¸€ä¸ªå‡½æ•°ä½“
* ä¼˜å…ˆçº§é—®é¢˜
* å®çš„ä»£ç æ‰§è¡Œæ•ˆç‡ä½ï¼ˆä½†æ˜¯çœç•¥äº†æ ˆå¸§ã€ä¼ å‚ã€è¿”å›ï¼‰

é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ç»å¸¸ä½¿ç”¨å®æ¥å®šä¹‰

##### ä¾‹å­1

```c
#define device_init_wakeup(dev,val) \
        do { \
                device_can_wakeup(dev) = !!(val); \
                device_set_wakeup_enable(dev,val); \
        } while(0)

#define device_init_wakeup(dev,val) \
                device_can_wakeup(dev) = !!(val); \
                device_set_wakeup_enable(dev,val);

if (n > 0)
	device_init_wakeup(d, v);
```

ifâ€¦elseè¯­å¥è¢«12è¡Œçš„ï¼›ç»“æŸäº†ï¼Œå› æ­¤å†™æˆdo{ â€¦ } çš„å½¢å¼

å–æ¶ˆå®å®šä¹‰

```c
#define X 3
... /* X is 3 */
#undef X
... /* X has no definition */
#define X 2
... /* X is 2 */
```



#### 2.2 å†…è”å‡½æ•°

å…³é”®å­—ï¼š`inline`

è¯¥å…³é”®å­—å‘Šè¯‰å†…æ ¸è¿™ä¸ªå¥½ä¹¦è°ƒç”¨å°½å¯èƒ½å¿«

æ— ç¼–è¯‘ä¼˜åŒ–ï¼šæ­¤æ—¶ä½œä¸ºæ­£å¸¸å‡½æ•°è°ƒç”¨

```bash
80483a0:       e8 9f ff ff ff          call   8048344 <MAX>
```

ç¼–è¯‘ä¼˜åŒ–åï¼š

```bash
int max(int n)
{
 8048355:       55                      push   %ebp
 8048356:       89 e5                   mov    %esp,%ebp
 8048358:       53                      push   %ebx
 8048359:       83 ec 04                sub    $0x4,%esp
 804835c:       8b 5d 08                mov    0x8(%ebp),%ebx
        return n == 0 ? a[0] : MAX(a[n], max(n-1));
 804835f:       85 db                   test   %ebx,%ebx
 8048361:       75 07                   jne    804836a <max+0x15>
 8048363:       a1 a0 95 04 08          mov    0x80495a0,%eax
 8048368:       eb 18                   jmp    8048382 <max+0x2d>
 804836a:       8d 43 ff                lea    -0x1(%ebx),%eax
 804836d:       89 04 24                mov    %eax,(%esp)
 8048370:       e8 e0 ff ff ff          call   8048355 <max>
inline int MAX(int a, int b)
{
        return a > b ? a : b;
 8048375:       8b 14 9d a0 95 04 08    mov    0x80495a0(,%ebx,4),%edx
 804837c:       39 d0                   cmp    %edx,%eax
 804837e:       7d 02                   jge    8048382 <max+0x2d>
 8048380:       89 d0                   mov    %edx,%eax
int a[] = { 9, 3, 5, 2, 1, 0, 8, 7, 6, 4 };
```

å¯å‘ç°å¹¶æ²¡æœ‰è°ƒç”¨MAXå‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥å†…è”åœ¨`max`å‡½æ•°ä¸­

#### 2.4 å®å±•å¼€

```c
#define x 3
#define f(a) f(x * (a))
#undef x
#define x 2
#define g f
#define t(a) a

t(t(g)(0) + t)(1);
```

å±•å¼€æ­¥éª¤ï¼š

1. æŠŠgå±•å¼€æˆåˆ†fï¼Œè½¬æ¢ä¸º`t(f(0) + t)(1);`
2. æ ¹æ®2å·å®šä¹‰å±•å¼€ï¼Œå¾—åˆ°`t(f(x * (0)) + t)(1)`
3. æŠŠxæ›¿æ¢ä¸º2ï¼Œå¾—åˆ°



### 3.æ¡ä»¶é¢„å¤„ç†

å¤´æ–‡ä»¶å¤„ç†

```c
#ifndef HEADER_FILENAME
#define HEADER_FILENAME
/* body of header */
#endif
```



## ç¬¬ 23 ç«  æŒ‡é’ˆ

### 1.åŸºç¡€

é—´æ¥å¯»å€ + æ•°ç»„ç´¢å¼•ï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•´æ•°ï¼‰

![æŒ‡é’ˆçš„åŸºæœ¬æ¦‚å¿µ](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/pointer.pointer0.png)

```c
int main(int argc, char const *argv[])
{
    int i;
    // å†…å­˜å•å…ƒçš„åœ°å€ä¿å­˜åœ¨å¦å¤–ä¸€ä¸ªå†…å­˜å•å…ƒ
    int *pi = &i;
    char c;
    char *pc = &c;
    return 0;
}
```

içš„åœ°å€æ˜¯åœ¨ç¼–è¯‘é“¾æ¥æ—¶ç¡®å®šçš„ï¼Œä¸éœ€è¦åˆ°è¿è¡Œæ—¶æ‰çŸ¥é“

`*`æŒ‡é’ˆé—´æ¥å¯»å€è¿ç®—ç¬¦ï¼ˆIndirection Operatorï¼‰,`*pi`è¡¨ç¤ºå–æŒ‡é’ˆpiæ‰€æŒ‡å‘çš„å˜é‡çš„å€¼ï¼Œä¹Ÿç§°ä¸ºDereference,å˜é‡çš„å¼•ç”¨ã€‚

é‡æŒ‡é’ˆï¼šä¸ç¡®å®šåœ°å€çš„æŒ‡é’ˆï¼Œé˜²æ­¢é‡æŒ‡é’ˆï¼Œåœ¨å®šä¹‰æŒ‡é’ˆéœ€è¦åˆå§‹åŒ–æŒ‡é’ˆä¸ºå…·ä½“å€¼

```c
int main(void)
{
  int *p = NULL;
  *p = 0;
}
```

NULLåœ¨Cæ ‡å‡†åº“çš„å¤´æ–‡ä»¶`stddef.h`ä¸­å®šä¹‰ï¼š

```c
#define NULL ((void *)0)
```

æŠŠåœ°å€0è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼ŒOSä¸ä¼šæŠŠä»»ä½•æ•°æ®ä¿å­˜åœ¨åœ°å€0é™„è¿‘ï¼Œ`void *`æŒ‡é’ˆä¸å…¶ä»–ç±»å‹çš„æŒ‡é’ˆå¯ä»¥éšå¼è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆï¼Œå¸¸ç”¨äºå‡½æ•°æ¥å£ã€‚



### 2.æŒ‡é’ˆç±»å‹çš„å‚æ•°å’Œè¿”å›å€¼

```c
int *swap(int *px, int *py)
{
    int temp;
    temp = *px;
    *px = *py;
    *py = temp;
    return px;
}
```

æ­¤å¤„å°†åªæ˜¯å°†pxï¼Œpyåœ°å€æŒ‡å‘çš„å€¼è¿›è¡Œäº†äº¤æ¢ï¼Œè€Œæ²¡æœ‰äº¤æ¢iï¼Œjçš„å€¼ã€‚

```c
int i = 10, j = 20;
int *p = swap(&i, &j);
```



### 3.æŒ‡é’ˆä¸æ•°ç»„

æ•°ç»„æ˜åšå³å€¼æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºæŒ‡å‘é¦–å…ƒç´ çš„æŒ‡é’ˆã€‚æ„æ€ä¸º`a[2]`ç­‰ä»·äº`*(a+2)`ï¼Œæ‰€ä»¥äº§ç”Ÿäº†ä»¥ä¸‹å†™æ³•ã€‚

```c
int *pa = a;
```

æ­¤æ—¶paæŒ‡å‘açš„é¦–åœ°å€

#### æ¯”è¾ƒè¿ç®—ç¬¦

åªæ˜¯æ¯”è¾ƒåŒä¸€æ•°ç»„ä¸­å…ƒç´ ä¸­çš„æŒ‡é’ˆæ‰æœ‰æ„ä¹‰ï¼Œä¸”æ¯”è¾ƒæŒ‡é’ˆé—´çš„åœ°å€ã€‚

ä¾‹å¦‚ï¼ŒæŒ‡é’ˆç›¸å‡è¡¨ç¤ºå…ƒç´ çš„ä¸ªæ•°ï¼ŒæŒ‡é’ˆç›¸åŠ æ— æ„ä¹‰ï¼Œæ‰€ä»¥ä¸å…è®¸ç›¸åŠ .

> Rule of Least SurpriseåŸåˆ™ï¼Œä½ çš„åŠŸèƒ½ä¸èƒ½è®©å®¢æˆ·æ„Ÿåˆ°æƒŠè®¶ï¼

**æ³¨æ„ï¼š**

æ•°ç»„åšå·¦å€¼æ—¶ä¸ä»£è¡¨å…ƒç´ é¦–åœ°å€ï¼Œåªä»£è¡¨å…ƒç´ ç©ºé—´ã€‚

#### å‡½æ•°ä¼ å‚

æŒ‡é’ˆå†™æ³•

```c
void func(int *a)
{
	...
}
```

æ•°ç»„å†™æ³•

```c
void func(int a[])
{
	...
}
```

è¿™ä¸¤ç§å†™æ³•å¯¹ç¼–è¯‘å™¨çœ‹æ¥æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½ä»£è¡¨æŒ‡é’ˆï¼Œå¦‚æœå‚æ•°æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ é€šå¸¸å†™æˆæŒ‡é’ˆå½¢å¼ï¼ŒæŒ‡å‘ä¸€ä¸²å…ƒç´ çš„é¦–å…ƒç´ ï¼Œåˆ™ç»å¸¸å†™æˆæ•°ç»„çš„å½¢å¼ã€‚



### 4.æŒ‡é’ˆä¸consté™å®šç¬¦

> *å·å¯å•ç‹¬çœ‹ä½œä¸€ä¸ªå˜é‡ï¼Œè¿™æ ·æ–¹ä¾¿ç†è§£

å¸¸è§å†™æ³•ï¼š

```c
const int *a;
int const *a;
```

* æŒ‡å‘`const int`å‹ï¼ŒaæŒ‡å‘å†…å­˜å•å…ƒä¸å¯æ”¹å†™ï¼Œå³`(*a)++`ä¸å…è®¸ï¼Œä½†æ˜¯aå¯ä»¥æ”¹å†™

```c
int * const a;
```

* aæ˜¯ä¸€ä¸ªæŒ‡å‘intå‹çš„constæŒ‡é’ˆï¼Œæ­¤æ—¶constä¿®é¥°aï¼Œ*aå¯ä»¥æ”¹å†™

```c
int const * const a;
```

* aæ˜¯ä¸€ä¸ªæŒ‡å‘const intå‹çš„constæŒ‡é’ˆï¼Œ*aå’Œaéƒ½ä¸å¯ä»¥æ”¹å†™

**æ³¨æ„:æŒ‡å‘`const`çš„å˜é‡ä¸å¯ä»¥æŒ‡å‘é`const`å˜é‡**

è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢æ‰€æŒ‡å‘çš„å†…å­˜å•å…ƒè¢«æ›´æ”¹ï¼Œåä¹‹åˆ™å¯ä»¥ã€‚

#### `const`çš„ä½œç”¨

1. å†™ä»£ç æ—¶ä¸å¿…æ‹…å¿ƒæ‰€æŒ‡å‘çš„å†…å­˜å•å…ƒè¢«ä¿®æ”¹
2. æŠŠä¸è¯¥å˜åŒ–çš„å°½å¯èƒ½éƒ½å†™æˆ`const`
3. `const`å¯¹ç¼–è¯‘å™¨ä¼˜åŒ–å¾ˆæœ‰å¸®åŠ©



### 5.æŒ‡é’ˆä¸ç»“æ„ä½“

```c
struct unit {
    char c;
    int num;
};

struct unit u;
struct unit *p = &u;
```

å®šä¹‰ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå’Œå˜é‡ï¼Œè®¿é—®æ—¶å¯ä»¥å†™æˆ`(*p).c`ã€`(*p).num`ï¼Œä»£è¡¨çš„æ„æ€ä¸ºå–påœ°å€ä¸‹çš„è¿™ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥å†™æˆ`p->c`ã€`p->num`ï¼Œè¿™æ ·æ›´åŠ ç®€æ´ã€‚



### 6. æŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆä¸æŒ‡é’ˆæ•°ç»„

æŒ‡é’ˆæ•°ç»„ï¼š

```c
int *a[10];
```

è¿™é‡Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯`int *`ç±»å‹çš„ï¼Œä»–æ˜¯ç­‰ä»·äº

```c
int **pa;
```

å¦‚æœè®©paæŒ‡å‘açš„é¦–å…ƒç´ ï¼Œåˆ™æœ‰ï¼š

```c
int * a[10];
int **pa = &a[0];
```

å¯¹æ¯”æ­£å¸¸æ•°ç»„

```c
int *pa = a;
```

a[0]ä»£è¡¨ç¬¬ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå–åœ°å€è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆç¬¦å·æŒ‡å‘æŒ‡é’ˆå˜é‡çš„åœ°å€ã€‚

#### æ·±å…¥mainçš„å‚æ•°

```c
int main(int argc, char const *argv[])
{
    /* code */
    return 0;
}
```

æ­¤å¤„ä½¿ç”¨çš„argvè¡¨ç¤ºä¸€è¿ä¸²çš„æŒ‡é’ˆå˜é‡ç­‰ä»·äº`**argv`ï¼Œå†™æˆè¿™ç§å½¢å¼æ˜¯ä¸ºäº†è¡¨ç¤ºæŒ‡å‘ä¸€ä¸ªæ•°ç»„çš„é¦–å…ƒç´ ï¼Œæ¯ä¸ªæŒ‡é’ˆéƒ½ä¸º`char *`ç±»å‹

![argvæŒ‡é’ˆæ•°ç»„1](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/pointer.argv-20220907210027357.png)

ç”±äºå†…å­˜æ¨¡å‹ä¸ºè¿™ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è¿™æ ·å†™

```c
for(i=0; argv[i] != NULL; i++)
```



### 7.æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆä¸å¤šç»´æ•°ç»„

æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ

```c
int (*a)[10];
```

ç›¸æ¯”äºæŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œå¤šäº†ä¸€ä¸ª`()`ï¼Œè®¤ä¸º`[]`æ¯”`*`ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœaå…ˆå’Œ`*`ç»“åˆè¡¨ç¤ºè¿™æ˜¯ä¸ªæŒ‡é’ˆï¼Œå¦‚æœå’Œ`[]`åˆ™è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚

å› æ­¤å¯ä»¥æ‹†æˆä¸¤ä¸ªï¼š

`int *a[10]`è¡¨ç¤ºä¸ºï¼š

```c
typedef int *t;
t a[10];
```

tä»£è¡¨`int *`ç±»å‹çš„æŒ‡é’ˆï¼Œaè¡¨ç¤ºè¿™ç§ç±»å‹ç»„æˆçš„æ•°ç»„ã€‚

`int (*a)[10]`åˆ™å¯ä»¥æ‹†æˆï¼š

```c
typedef int t[10];
t *a;
```

tä»£è¡¨ç”±10ä¸ªintç»„æˆçš„æ•°ç»„ç±»å‹ï¼Œaä»£è¡¨æŒ‡å‘è¿™ç§ç±»å‹çš„æ•°ç»„ï¼Œç±»ä¼¼ç»“æ„ä½“ã€‚

#### æ•°ç»„æŒ‡é’ˆçš„ä½¿ç”¨

```c
int a[10];
int (*pa)[10] = &a[0];
```

aæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ&aä¸­ï¼Œæ•°ç»„åä¸ºå·¦å€¼ï¼Œå–æ•°ç»„çš„é¦–åœ°å€å¤åˆ¶ç»™æŒ‡é’ˆpaï¼Œæ³¨æ„ï¼š&aè¡¨ç¤ºå–æ•°ç»„açš„é¦–åœ°å€ï¼Œ&a[0]è¡¨ç¤ºå–æ•°ç»„aç¬¬ä¸€ä¸ªå…ƒç´ çš„é¦–åœ°å€ï¼Œè¿™ä¸¤ä¸ªæ•°å€¼ç›¸åŒï¼Œ&aè¡¨ç¤ºæŒ‡é’ˆint (*)[10]ï¼Œ&a[0]è¡¨ç¤ºint *ã€‚



### 8.å‡½æ•°ç±»å‹å’Œå‡½æ•°æŒ‡é’ˆç±»å‹

å‡½æ•°æŒ‡é’ˆå­˜æ”¾å‡½æ•°çš„å…¥å£åœ°å€

```c
#include <stdio.h>

void say_hello(const char *str){
    printf("Hello %s\n", str);
}

int main(int argc, char const *argv[])
{
    void (*f)(const char *) = say_hello;
    f("Guys");
    return 0;
}
```

fçš„ç±»å‹å£°æ˜ï¼š`void(*f)(const char *)`ï¼Œ*åé¢ï¼Œæ‰€ä»¥fæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚è¿”å›å€¼ï¼Œå‚æ•°

å‡½æ•°ç±»å‹ä¸æ•°ç»„ç±»å‹ç›¸ä¼¼ï¼Œåšå³å€¼æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼Œè¿™é‡Œåšäº†ä¸€æ¬¡ç±»å‹è½¬æ¢ã€‚å½“ç„¶å¯ä»¥ç›´æ¥å†™æˆ`void (*f)(const char *) = &say_hello`ï¼Œç›´æ¥å–åœ°å€å†èµ‹å€¼ç»™fï¼Œå°±ä¸éœ€è¦è‡ªåŠ¨è½¬æ¢ç±»å‹äº†ã€‚

#### å‡½æ•°è°ƒç”¨çš„åŒºåˆ«

* `f(â€œguaysâ€)`ï¼šç›´æ¥å†™æ³•ï¼Œè¦æ±‚æ“ä½œæ•°æ˜¯å‡½æ•°æŒ‡é’ˆ
* `(*f)(â€œguysâ€)`ï¼šæŠŠå‡½æ•°ç±»å‹è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆç„¶ååšçš„å‡½æ•°è°ƒç”¨



#### æŒ‡é’ˆä¸ç›´æ¥å‡½æ•°è°ƒç”¨åŒºåˆ«

* å½“å‡½æ•°ä¸­æœ‰å¤šå±‚if..elseæ—¶ï¼Œä½¿ç”¨å‡½æ•°æŒ‡é’ˆæ›´å¥½
* å°è£…å¤šä¸ªå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼Œè°ƒç”¨æ—¶å‡½æ•°æŒ‡é’ˆå–å‡ºç›¸åº”çš„å‡½æ•°



### 9.ä¸å®Œå…¨ç±»å‹å’Œå¤æ‚å£°æ˜

![Cè¯­è¨€ç±»å‹æ€»ç»“](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/pointer.type.gif)

* å‡½æ•°ç±»å‹
* å¯¹è±¡ç±»å‹
  * æ ‡é‡ç±»å‹
    * æŒ‡é’ˆç±»å‹
    * æ•°å­¦ç±»å‹
  * éæ ‡é‡ç±»å‹
* ä¸å®Œå…¨ç±»å‹

> å–è‡ªStandard C

#### ä¸å®Œå…¨ç±»å‹

> ä¸çŸ¥é“è¯¥ç§ç±»å‹å å‡ ä¸ªå­—èŠ‚

```c
struct s;
union u;
char str[];
```

ä¸å®Œå…¨ç±»å‹å¯ä»¥é€šè¿‡å¤šæ¬¡å£°æ˜å˜ä¸ºå®Œå…¨ç±»å‹

```c
char str[];
char str[10];
```

#### ç»“æ„ä½“

```c
struct s {
  struct t *pt;
}

struct t {
  struct s *ps;
}
```

ç”±äºç¼–è¯‘å™¨ä»å‰å¾€åç¼–è¯‘ï¼Œçœ‹åˆ°sæ˜¯ä¸€ä¸ªä¸å®Œå…¨ç±»å‹ï¼Œtä¹Ÿæ˜¯ä¸€ä¸ªä¸å®Œå…¨ç±»å‹ï¼Œä½†ptæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼ŒæŒ‡é’ˆçš„å­˜å‚¨å¤§å°ç¡®å®šã€‚æ¥ä¸‹ä¿©ï¼Œç¼–è¯‘å™¨çœ‹åˆ°tï¼Œæ­¤æ—¶tæœ‰äº†å®Œæ•´çš„å®šä¹‰ï¼Œå› ä¸ºså®šä¹‰å®Œæ•´ï¼Œå…ˆæ˜¯ptçš„ç±»å‹æœ‰å®Œæ•´å®šä¹‰ï¼Œç„¶åå†æ˜¯psæœ‰äº†å®Œæ•´å®šä¹‰ã€‚

ç»“è®ºï¼šcè¯­è¨€ä¸­å¯ä»¥é€’å½’å®šä¹‰æŒ‡é’ˆæˆå‘˜ï¼Œä½†ä¸èƒ½é€’å½’å®šä¹‰å˜é‡æˆå‘˜ã€‚

é“¾è¡¨çš„ç”±æ¥ï¼š

```c
struct s {
  char data[6];
  struct s* next;
}
```

#### åˆ†è§£å‡½æ•°å£°æ˜

1. å…ˆçœ‹æŒ‡é’ˆ
2. é€æ­¥æ›¿æ¢

```c
int (*(*fp) (void *)) [10];
```

1. *fpæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘T1ç±»å‹

```c
int (*T1 (void *))[10];
typedef T1 *fp;
```

2. T1ä¸ºå‡½æ•°ç±»å‹ï¼Œå‚æ•°ä¸ºvoidï¼Œè¿”å›å€¼ä¸ºT2ç±»å‹

```c
typedef int (*T2)[10];
typedef T2 T1(void *);
typedef T1 *fp;
```

3. T2å’Œ*ç»„åˆåœ¨ä¸€èµ·ä¹Ÿä¸ºæŒ‡é’ˆï¼ŒæŒ‡å‘T3çš„æŒ‡é’ˆ

```c
typedef int T3[10];
typedef T3 *T2;
typedef T2 T1(void *);
typedef T1 *fp;
```

æ˜¾ç„¶ï¼ŒT3æ˜¯ä¸€ä¸ªintæ•°ç»„ï¼Œç”±åä¸ªå…ƒç´ ç»„æˆã€‚

æœ€åæ¥çœ‹ï¼š

1. æœ€å¤–å±‚ä¸ºä¸€ä¸ªintæ•°ç»„ï¼ˆT3ï¼‰
2. ç¬¬ä¸€å†…å±‚ä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆT2ï¼‰
3. æœ€å†…å±‚ä¸ºä¸€ä¸ªå‡½æ•°ç±»å‹ï¼ˆT1ï¼‰



## ç¬¬24ç«  å‡½æ•°æ¥å£

### 1.æœ¬ç« é¢„å¤‡

#### 1.1 `strcpy`ä¸`strncpy`

**Man Pageå¾ˆé‡è¦**

strcpyçš„man page

![image-20220908122056565](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/image-20220908122056565.png)

SYNOPSIS(ç®€ä»‹)ï¼šè¡¨ç¤ºå‡½æ•°åŸå‹

**æ³¨æ„ï¼š**srcä¸ºconstï¼Œè¯æ˜æ‰€åœ¨çš„å†…å­˜ç©ºé—´ä¸èƒ½è¢«æ”¹å†™

strcpyåªçŸ¥é“`src`çš„é¦–åœ°å€ï¼Œä¸çŸ¥é“é•¿åº¦ï¼Œä»–ä¼šä¸€ç›´æ‹·è´åˆ°`\0`ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„æ•°ç»„æ˜¯å¦ä¼šè¶Šç•Œï¼Œæ­¤å¤–è¿˜ä¸åº”è¯¥æœ‰é‡å ã€‚

strncpyé™¤äº†å¯ä»¥æŒ‡å®šé•¿åº¦å¤–ï¼Œè¿˜å¯ä»¥å®ç°ç¼ºçœè¡¥`\0`

#### 1.2 mallocä¸free

åˆ†é…ä¸€å—å…¨å±€å†…å­˜ç©ºé—´ï¼Œå…¶ä»–ä¸å¯è®¿é—®

mallocåœ¨åº•å±‚é€šè¿‡`brk`ç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œå‡½æ•°è¿”å›é€šç”¨`void *`ï¼ŒåŠ¨æ€åˆ†é…çš„å†…å­˜ç”¨å®Œä¹‹åå¯ä»¥ç”¨`free`é‡Šæ”¾æ‰å§ã€‚

##### å†…å­˜æ³„æ¼

å†…å­˜åˆ†é…åè€Œä¸é‡Šæ”¾

malloc(0)ä¹Ÿæ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ä¸èƒ½é€šè¿‡è¿™æŒ‡é’ˆè®¿é—®å†…å­˜

##### mallocä¸freeçš„å®ç°



##### ä¾‹å­ï¼š

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct {
    int number;
    char *msg;
} unit_t;

int main(int argc, char const *argv[])
{
    // éšå¼è½¬æ¢
    unit_t *p = malloc(sizeof(unit_t));
    // å†…å­˜åˆ†é…åéœ€è¦åˆ¤æ–­
    if(p == NULL){
        printf("out of memory\n");
        exit(1);
    }
    p->number = 3;
    p->msg = malloc(20);
    strcpy(p->msg, "Hello world!");
    printf("number: %d\nmsg: %s\n", p->number, p->msg);
    // æ³¨æ„é¡ºåºä¸èƒ½å˜ï¼Œå¦åˆ™på°±å˜æˆäº†é‡æŒ‡é’ˆ msgå°±æˆäº†å†…å­˜ç¢ç‰‡
    free(p->msg);
    // å°†pçš„ç©ºé—´å½’è¿˜ï¼Œä½†æ˜¯å€¼å¹¶æ²¡æœ‰å˜åŒ–
    // freeåªèƒ½å¤Ÿæ¸…é™¤ç©ºé—´
    free(p);
    p = NULL;

    return 0;
}
```



### 2.ä¼ å…¥å‚æ•°ä¸ä¼ å‡ºå‚æ•°

ä¼ å…¥å‚æ•°

```c
unit_t u; 
set_unit(&u);
```

ä¼ å‡ºå‚æ•°

```c
void set_unit(unit_t *p)
```



### 3.ä¸¤å±‚æŒ‡é’ˆçš„å‚æ•°

```c
void get_a_day(const char **);
```

è¿™é‡Œè¡¨ç¤ºä¼ å‡ºå‚æ•°

ä¼ å…¥å‚æ•°è¡¨ç¤ºï¼š

```c
const char *firstday = NULL;
get_a_day(&firstday);
```

ä¹Ÿå¯ä»¥åœ¨å‡½æ•°ä¸­åˆ†é…å†…å­˜ï¼Œå‡½æ•°è¿”å›æŒ‡å‘è¯¥å†…å­˜çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ä¸€èˆ¬æ„é€ å‡½æ•°å’Œææ„é€ å‡½æ•°

#### è°ƒç”¨è€…ï¼š

1. åˆ†é…ç©ºé—´
2. è°ƒç”¨å‡½æ•°åˆ†é…å†…å­˜
3. è°ƒç”¨å‡½æ•°é‡Šæ”¾å†…å­˜

#### å®ç°è€…ï¼š

1. è§„å®šæŒ‡é’ˆç±»å‹
2. åˆ†é…å†…å­˜å¹¶å®Œæˆåˆå§‹åŒ–
3. é‡Šæ”¾å†…å­˜

#### ä¸ºä»€ä¹ˆä¸åœ¨`main`å‡½æ•°ä¸­é‡Šæ”¾å†…å­˜ï¼Ÿ



### 4.è¿”å›å€¼ä¸ºæŒ‡é’ˆ

* ä¼ å‡ºé™æ€å†…å­˜æˆ–è€…å·²åˆ†é…çš„åŠ¨æ€å†…å­˜çš„æŒ‡é’ˆ
* åœ¨å‡½æ•°ä¸­åŠ¨æ€åˆ†é…å†…å­˜å¹¶ä¼ å‡ºæŒ‡å‘è¿™å—å†…å­˜çš„æŒ‡é’ˆ

åµŒå¥—æŒ‡é’ˆæ—¶ï¼Œéœ€è¦å¤šå±‚åˆ†é…å†…å­˜ï¼Œè¿”å›æ—¶åªè¿”å›æœ€é«˜å±‚ï¼ŒåŒæ—¶é‡Šæ”¾ä¹Ÿä¸€æ ·ã€‚



### 5. å›è°ƒå‡½æ•°

å‚æ•°ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œè°ƒç”¨è€…ä¼ é€’ä¸€ä¸ªå‡½æ•°çš„åœ°å€ç»™å®ç°è€…ï¼Œè®©å®ç°è€…è°ƒç”¨å®ƒã€‚

```c
// å®šä¹‰å‡½æ•°æŒ‡é’ˆ
typedef void (*callback_t)(void *);
// åªå®šä¹‰äº†å‚æ•°ç±»å‹
extern void repeat_three_times(callback_t, void *);
```

* æ³¨æ„è¿™é‡Œçš„å‡½æ•°è¿”å›å€¼ä¸ºvoidï¼Œå‚æ•°ä¸ºä¸‡èƒ½æŒ‡é’ˆï¼ˆå‚æ•°ç±»å‹ç”±å®ç°è€…å»è§„å®šï¼‰

```c
void repeat_three_times(callback_t f, void *para)
{
    f(para);
    f(para);
    f(para);
}
```

å›è°ƒå‡½æ•°å…¸å‹åº”ç”¨ä¸ºï¼šC++èŒƒå‹

è°ƒç”¨è€…ä¸€èˆ¬ä¼šé—´æ¥è°ƒç”¨è‡ªå·±çš„å‡½æ•°ï¼š

1. è°ƒç”¨è€…å°†å›è°ƒå‡½æ•°ä¼ ç»™å®ç°è€…
2. å®ç°è€…è®°ä½è¿™ä¸ªå‡½æ•°ï¼Œ**æ³¨å†Œ**å›è°ƒå‡½æ•°
3. ç„¶åæŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨æ³¨å†Œè¿‡çš„å‡½æ•°

#### å¸¸ç”¨æ¡†æ¶

```c
/* registry.h */
#ifndef REGISTRY_H
#define REGISTRY_H

typedef void (*registry_t)(void);
extern void register_func(registry_t);

#endif
```

```c
/* registry.c */
#include <unistd.h>
#include "registry.h"

static registry_t func;

void register_func(registry_t f)
{
     func = f;
}

static void on_some_event(void)
{
     ...
     func();
     ...
}
```



### 6.å¯å˜å‚æ•°

```c
int printf(const char *format, ...);
```

Cåˆ°æ ‡å‡†åº“çš„`va_list`ç±»å‹å’Œ`va_start`ã€`va_arg`ã€`va_end`å®

#### LEAæŒ‡ä»¤

> load effective addressï¼ˆæŠŠæŸä¸ªå†…å­˜åœ°å€æ”¾åœ¨ç›®æ ‡ä½ç½®ï¼‰

```assembly
lea dest, src
```

ä¾‹å­ï¼š

```assembly
 my_printf("c\ts\n","1","hello");
    1355:       48 8d 15 a8 0c 00 00    lea    0xca8(%rip),%rdx        # 2004 <_IO_stdin_used+0x4>
    135c:       48 8d 35 a7 0c 00 00    lea    0xca7(%rip),%rsi        # 200a <_IO_stdin_used+0xa>
    1363:       48 8d 3d a2 0c 00 00    lea    0xca2(%rip),%rdi        # 200c <_IO_stdin_used+0xc>
    136a:       b8 00 00 00 00          mov    $0x0,%eax
    136f:       e8 15 fe ff ff          callq  1189 <my_printf>
```

ä»å³å‘å·¦ä¾æ¬¡å‹å…¥æ ˆï¼Œç¬¬ä¸€ä¸ªå‚æ•°é è¿‘æ ˆé¡¶ï¼Œç¬¬ä¸‰ä¸ªé è¿‘æ ˆåº•ã€‚

![myprintfå‡½æ•°çš„å‚æ•°å¸ƒå±€](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/interface.vaarg.png)

ä½†ä¸ºäº†ä½¿ç¬¬ä¸‰ä¸ªå‚æ•°å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿå 4ä¸ªå­—èŠ‚ã€‚



#### å®ç°åŸç†

`stdarg.h`çš„ä¸€ç§å®ç°

```c
/* stdarg.h standard header */
#ifndef _STDARG
#define _STDARG

/* type definitions */
typedef char *va_list;
/* macros */
#define va_arg(ap, T) \
	(* (T *)(((ap) += _Bnd(T, 3U)) - _Bnd(T, 3U)))
#define va_end(ap) (void)0
#define va_start(ap, A) \
	(void)((ap) = (char *)&(A) + _Bnd(A, 3U))
#define _Bnd(X, bnd) (sizeof (X) + (bnd) & ~(bnd))
#endif
```

* `Bnd`å®ï¼šå°†å˜é‡Xçš„é•¿åº¦å¯¹é½åˆ°bnd+1å­—èŠ‚çš„æ•´æ•°å€
* `va_list`ï¼šæŒ‡é’ˆå˜é‡
* `va_start(ap, format)`å®ï¼šè®©apæŒ‡å‘formatå‚æ•°çš„ä¸‹ä¸€ä¸ªå‚æ•°
* `va_arg(ap, int)`å®ï¼šæŠŠç¬¬äºŒä¸ªå‚æ•°çš„å€¼æŒ‰intå–å‡ºæ¥ï¼Œä½¿apæŒ‡å‘ç¬¬ä¸‰ä¸ªå‚æ•°



#### `printf`åŸç†

* æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°æ¥ç¡®å®šåé¢æœ‰å‡ ä¸ªå‚æ•°ä»¥åŠç±»å‹
* è°ƒç”¨è€…éœ€è¦ä¿è¯ä¸ªæ•°ç¡®å®š

å¦ä¸€ç§æ–¹æ³•ï¼š

**æ ¹æ®Sengtinelåˆ¤æ–­å‚æ•°çš„ä¸ªæ•°**

ä¾‹å¦‚ï¼Œæœ«å°¾å˜é‡ä¼ å…¥ä¸€ä¸ªNULLï¼Œä»æ ˆä¸Šå–æ•°æ®åˆ°æ­¤å‚æ•°æ—¶ï¼Œé»˜è®¤ç»“æŸã€‚

æœ€åï¼Œéœ€è¦æ³¨æ„ï¼ŒCè¯­è¨€æ ‡å‡†è§„å®šéœ€è¦å®šä¹‰ä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ï¼Œ`va_start`ä¸­è¦ç”¨å‚æ•°åˆ—è¡¨æœ€åä¸€ä¸ªæœ‰åå­—çš„å‚æ•°ã€‚



## ç¬¬25ç«  Cæ ‡å‡†åº“

Man Page æ°¸è¿œçš„ç¥ï¼

### 1. å­—ç¬¦ä¸²æ“ä½œå‡½æ•°

åº“æ–‡ä»¶ï¼š

```c
#include <string.h>
```

#### 1.1åˆå§‹åŒ–å­—ç¬¦ä¸²

```c
void *memset(void *s, int c, size_t n);
è¿”å›å€¼ï¼šsæŒ‡å‘å“ªï¼Œè¿”å›çš„æŒ‡é’ˆå°±æŒ‡å‘å“ª
```

* å…¨å±€å’Œé™æ€å˜é‡ï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸º0
* å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œåˆå§‹å€¼ä¸ç¡®å®šï¼Œç”¨è¯¥å‡½æ•°åˆå§‹åŒ–ï¼Œè€Œä¸”`malloc`åˆå§‹åŒ–çš„å€¼ä¹Ÿæ˜¯ä¸ç¡®å®šçš„

#### 1.2 å–å­—ç¬¦ä¸²çš„é•¿åº¦

```c
size_t strlen(const char *s)
```

è¿”å›çš„é•¿åº¦ä¸åŒ…æ‹¬`\0`ï¼Œå®ç°åŸç†æ˜¯ä¸€ç›´å¯»æ‰¾`\0`

#### 1.3 æ‹·è´å­—ç¬¦ä¸²

* strcpyã€strncpyæ‹·è´ä»¥`\0`ç»“æŸçš„å­—ç¬¦ä¸²
* memcpyã€memmoveå‡½æ•°

```c
void *memcpy(void *dest, const void *src, size_t n);
void *memmove(void *dest, const void *src, size_t n);
è¿”å›å€¼ï¼šdestæŒ‡å‘å“ªï¼Œè¿”å›çš„æŒ‡é’ˆå°±æŒ‡å‘å“ª
```

memå‘½åçš„å‡½æ•°å¹¶ä¸å…³å¿ƒ`\0`ï¼Œ**è¯´æ˜å¹¶ä¸æŠŠå‚æ•°å½“ä½œå­—ç¬¦**ï¼Œå› æ­¤è¿”å›å€¼ä¸º`void *`

åŒºåˆ«ä¸ºï¼Œmoveä¸ºmemcpyçš„å‡çº§ç‰ˆï¼Œå†…å­˜é‡å æ—¶ä¹Ÿå¯ä»¥æ‹·è´æ­£ç¡®ã€‚

#### 1.4 è¿æ¥å­—ç¬¦ä¸²

```c
char *strcat(char *dest, const char *src);
char *strncat(char *dest, const char *src, size_t n);
è¿”å›å€¼ï¼šdestæŒ‡å‘å“ªï¼Œè¿”å›çš„æŒ‡é’ˆå°±æŒ‡å‘å“ª
```

#### 1.5 æ¯”è¾ƒå­—ç¬¦ä¸²

```c
#include <string.h>

int memcmp(const void *s1, const void *s2, size_t n);
int strcmp(const char *s1, const char *s2);
int strncmp(const char *s1, const char *s2, size_t n);
è¿”å›å€¼ï¼šè´Ÿå€¼è¡¨ç¤ºs1å°äºs2ï¼Œ0è¡¨ç¤ºs1ç­‰äºs2ï¼Œæ­£å€¼è¡¨ç¤ºs1å¤§äºs2
```

* memcmpï¼šæ¯”è¾ƒå‰nä¸ªå­—èŠ‚
* strcpyï¼šå½“å…¶ä¸­ä¸€ä¸ª`\0`æ—¶ç»“æŸæ¯”è¾ƒ
* Strlcpyï¼šæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œè¦ä¹ˆåœ¨å…¶ä¸­ä¸€ä¸ªå­—ç¬¦é‡åˆ°`\0`ç»“æŸï¼Œè¦ä¹ˆæ¯”è¾ƒæ™šnä¸ªå­—ç¬¦

#### 1.6 æœç´¢å­—ç¬¦ä¸²

```c
#include <string.h>

char *strchr(const char *s, int c);
char *strrchr(const char *s, int c);
è¿”å›å€¼ï¼šå¦‚æœæ‰¾åˆ°å­—ç¬¦cï¼Œè¿”å›å­—ç¬¦ä¸²sä¸­æŒ‡å‘å­—ç¬¦cçš„æŒ‡é’ˆï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›NULL
```

`strchr`åœ¨å­—ç¬¦ä¸²`s`ä¸­ä»å‰åˆ°åæŸ¥æ‰¾å­—ç¬¦`c`ï¼Œæ‰¾åˆ°å­—ç¬¦`c`ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®æ—¶å°±è¿”å›ï¼Œè¿”å›å€¼æŒ‡å‘è¿™ä¸ªä½ç½®ï¼Œå¦‚æœæ‰¾ä¸åˆ°å­—ç¬¦`c`å°±è¿”å›`NULL`ã€‚`strrchr`å’Œ`strchr`ç±»ä¼¼ï¼Œä½†æ˜¯ä»å³å‘å·¦æ‰¾å­—ç¬¦`c`ï¼Œæ‰¾åˆ°å­—ç¬¦`c`ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®å°±è¿”å›ï¼Œå‡½æ•°åä¸­é—´å¤šäº†ä¸€ä¸ªå­—æ¯rå¯ä»¥ç†è§£ä¸ºRight-to-leftã€‚

```c
#include <string.h>

char *strstr(const char *haystack, const char *needle);
è¿”å›å€¼ï¼šå¦‚æœæ‰¾åˆ°å­ä¸²ï¼Œè¿”å›å€¼æŒ‡å‘å­ä¸²çš„å¼€å¤´ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›NULL
```

`strstr`åœ¨ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ä¸­ä»å‰åˆ°åæ‰¾ä¸€ä¸ªå­ä¸²ï¼ˆSubstringï¼‰ï¼Œæ‰¾åˆ°å­ä¸²ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®å°±è¿”å›ï¼Œè¿”å›å€¼æŒ‡å‘å­ä¸²çš„å¼€å¤´ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›NULLã€‚è¿™ä¸¤ä¸ªå‚æ•°åå¾ˆå½¢è±¡ï¼Œåœ¨å¹²è‰å †`haystack`ä¸­æ‰¾ä¸€æ ¹é’ˆ`needle`ï¼ŒæŒ‰ä¸­æ–‡çš„è¯´æ³•å«å¤§æµ·æé’ˆï¼Œæ˜¾ç„¶`haystack`æ˜¯é•¿å­—ç¬¦ä¸²ï¼Œ`needle`æ˜¯è¦æ‰¾çš„å­ä¸²ã€‚

### 2. æ ‡å‡†I/Oåº“å‡½æ•°

è°ƒç”¨è€…åªæ˜¯å°†æ–‡ä»¶æŒ‡é’ˆåœ¨å“­å‡½æ•°æ¥å£ä¹‹é—´ä¼ æ¥ä¼ å»ï¼ŒFILEç»“æ„ä½“çš„æˆå‘˜åœ¨åº“å‡½æ•°å†…éƒ¨ç»´æŠ¤ï¼Œæœ‰ä½“ä¼šä¸€ä¸‹å°è£…ã€‚

```java
public     private 
```

#### 2.2 fopen/fclose

fopené”™è¯¯æ—¶ï¼Œè¿”å›NULLï¼Œå¹¶è®¾ç½®errnoï¼Œé€šå¸¸è¿™æ ·å†™

```c
if ( (fp = fopen("/tmp/file1","r")) == NULL){
  printf("error open file /tmp/file1!\n");
  exit(1);
}
```

fcloseè°ƒç”¨å‡ºé”™æ—¶ï¼Œè¿”å›EOF

```c
/* End of file character.
   Some things throughout the library rely on this being -1.  */
#ifndef EOF
# define EOF (-1)
#endif
```

### 2.3 stdin/stdout/stderr





#### 2.10 Cæ ‡å‡†åº“çš„I/Oç¼“å†²åŒº

* Cæ ‡å‡†åº“ä¸ºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶åˆ†é…ä¸€ä¸ªI/Oç¼“å†²åŒºï¼Œé€šè¿‡æ–‡ä»¶FILEç»“æ„ä½“å¯ä»¥æ‰¾åˆ°ç¼“å†²åŒº
* ç”¨æˆ·è¯»å†™å‡½æ•°å¤šæ•°éƒ½åœ¨ç¼“å†²åŒºï¼Œå°‘éƒ¨åˆ†è¯·æ±‚å†…æ ¸
* ç”¨æˆ·æ¯æ¬¡ç¬¬ä¸€è°ƒç”¨è¯»å†™å‡½æ•°ä¼šè¿›å…¥å†…æ ¸ï¼Œç„¶åæŠŠæ•°æ®æ”¾åˆ°ç¼“å†²åŒºï¼Œç”¨æˆ·åœ¨ç¼“å†²åŒºè¿›è¡Œè¯»å†™

##### Cæ ‡å‡†åº“ç¼“å†²åŒºä¸ç”¨æˆ·ç¼“å†²åŒº

![Cæ ‡å‡†åº“çš„I/Oç¼“å†²åŒº](https://personal-drawing-bed.oss-cn-beijing.aliyuncs.com/img/stdlib.buffer.png)



* å…¨ç¼“å†²ï¼šå†™æ»¡åå°±è¿”å›å†…æ ¸
* è¡Œç¼“å†²ï¼šæœ‰æ¢è¡Œå°±å†™å›å†…æ ¸ï¼Œæˆ–è€…å†™æ»¡ï¼Œæ ‡å‡†è¾“å…¥å’Œè¾“å‡ºé€šå¸¸ä¸ºè¡Œç¼“å†²
* æ— ç¼“å†²ï¼šå°½å¿«é€šè¿‡ç³»ç»Ÿè°ƒç”¨å†™å…¥å†…æ ¸

##### ä¸ºä»€ä¹ˆæ²¡æœ‰è¾“å‡ºï¼Ÿ

`printf("hello world");`æ‰“å°çš„å­—ç¬¦ä¸²ä¸­æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œæ‰€ä»¥åªæŠŠå­—ç¬¦ä¸²å†™åˆ°æ ‡å‡†è¾“å‡ºçš„I/Oç¼“å†²åŒºä¸­è€Œæ²¡æœ‰å†™å›å†…æ ¸ï¼ˆå†™åˆ°ç»ˆç«¯è®¾å¤‡ï¼‰ï¼Œå¦‚æœæ•²Ctrl-Cï¼Œè¿›ç¨‹æ˜¯å¼‚å¸¸ç»ˆæ­¢çš„ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨`exit`ï¼Œä¹Ÿå°±æ²¡æœ‰æœºä¼šFlush I/Oç¼“å†²åŒºï¼Œå› æ­¤å­—ç¬¦ä¸²æœ€ç»ˆæ²¡æœ‰æ‰“å°åˆ°å±å¹•ä¸Šã€‚

å»æ‰while(1);ä¹Ÿå¯ä»¥æ‰“å°ï¼Œç¨‹åºé€€å‡ºæ—¶ä¼šè°ƒç”¨exit Flushæ‰€æœ‰I/Oç¼“å†²åŒº

```c
#include <stdio.h>

int main()
{
	printf("hello world");
	fflush(stdout);
	while(1);
}
```

* ç”¨æˆ·è°ƒç”¨`fflush`å¼ºåˆ¶å†™å›å†…æ ¸

* è¯¥å‡½æ•°ç¡®ä¿æ•°æ®å†™å›äº†å†…æ ¸ï¼Œä»¥å…è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢ä¸¢å¤±æ•°æ®

  

